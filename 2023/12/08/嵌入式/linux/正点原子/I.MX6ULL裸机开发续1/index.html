<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="linux的嵌入式开发第三步，学习linux-ARM相关开发，使用MPU为：I.MX6ULL">
<meta property="og:type" content="article">
<meta property="og:title" content="嵌入式linux入门(三)：linux-ARM裸机二">
<meta property="og:url" content="http://example.com/2023/12/08/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="linux的嵌入式开发第三步，学习linux-ARM相关开发，使用MPU为：I.MX6ULL">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-12-08T04:29:47.824Z">
<meta property="article:modified_time" content="2023-12-26T05:00:40.972Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2023/12/08/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2023/12/08/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD1/","path":"2023/12/08/嵌入式/linux/正点原子/I.MX6ULL裸机开发续1/","title":"嵌入式linux入门(三)：linux-ARM裸机二"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>嵌入式linux入门(三)：linux-ARM裸机二 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E4%B8%BB%E9%A2%91%E5%92%8C%E6%97%B6%E9%92%9F%E9%85%8D%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">8. 主频和时钟配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">8.1. 基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">1.2.</span> <span class="nav-text">8.2. 代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-clk-c"><span class="nav-number">1.2.1.</span> <span class="nav-text">bsp_clk.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-GPIO%E4%B8%AD%E6%96%AD"><span class="nav-number">2.</span> <span class="nav-text">9. GPIO中断</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E4%B8%AD%E6%96%AD%E7%9B%B8%E5%85%B3"><span class="nav-number">2.1.</span> <span class="nav-text">9.1. 中断相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E8%A1%A8"><span class="nav-number">2.1.1.</span> <span class="nav-text">中断向量表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E5%81%8F%E7%A7%BB"><span class="nav-number">2.1.2.</span> <span class="nav-text">中断向量偏移</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GIC%E4%B8%AD%E6%96%AD%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">2.1.3.</span> <span class="nav-text">GIC中断控制器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IMX6U%E4%B8%AD%E6%96%ADID"><span class="nav-number">2.1.4.</span> <span class="nav-text">IMX6U中断ID</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">9.2. 基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">2.3.</span> <span class="nav-text">9.3.代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-int-h"><span class="nav-number">2.3.1.</span> <span class="nav-text">bsp_int.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-int-c"><span class="nav-number">2.3.2.</span> <span class="nav-text">bsp_int.c</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-exti-h"><span class="nav-number">2.3.3.</span> <span class="nav-text">bsp_exti.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-exti-c"><span class="nav-number">2.3.4.</span> <span class="nav-text">bsp_exti.c</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-gpio-h"><span class="nav-number">2.3.5.</span> <span class="nav-text">bsp_gpio.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-gpio-c"><span class="nav-number">2.3.6.</span> <span class="nav-text">bsp_gpio.c</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="nav-number">2.4.</span> <span class="nav-text">9.4. 问题解决</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0GPIO%E4%B8%AD%E6%96%AD%E5%90%8E%E4%BB%A3%E7%A0%81%E5%8D%A1%E6%AD%BB"><span class="nav-number">2.4.1.</span> <span class="nav-text">添加GPIO中断后代码卡死</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="nav-number">2.4.1.1.</span> <span class="nav-text">解决办法</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-EPIT%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="nav-number">3.</span> <span class="nav-text">10. EPIT定时器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">3.1.</span> <span class="nav-text">10.1. 基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">3.2.</span> <span class="nav-text">10.2. 代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-epit-h"><span class="nav-number">3.2.1.</span> <span class="nav-text">bsp_epit.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-epit-c"><span class="nav-number">3.2.2.</span> <span class="nav-text">bsp_epit.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-%E6%8C%89%E9%94%AE%E6%B6%88%E6%8A%96"><span class="nav-number">4.</span> <span class="nav-text">11. 按键消抖</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">4.1.</span> <span class="nav-text">11.1. 代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-keyfilter-h"><span class="nav-number">4.1.1.</span> <span class="nav-text">bsp_keyfilter.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-keyfilter-c"><span class="nav-number">4.1.2.</span> <span class="nav-text">bsp_keyfilter.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-GPT%E9%AB%98%E7%B2%BE%E5%BA%A6%E5%BB%B6%E6%97%B6"><span class="nav-number">5.</span> <span class="nav-text">12. GPT高精度延时</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">5.1.</span> <span class="nav-text">12.1. 基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">5.2.</span> <span class="nav-text">12.2. 代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-delay-h"><span class="nav-number">5.2.1.</span> <span class="nav-text">bsp_delay.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-delay-c"><span class="nav-number">5.2.2.</span> <span class="nav-text">bsp_delay.c</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/08/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="嵌入式linux入门(三)：linux-ARM裸机二 | Hexo">
      <meta itemprop="description" content="linux的嵌入式开发第三步，学习linux-ARM相关开发，使用MPU为：I.MX6ULL">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          嵌入式linux入门(三)：linux-ARM裸机二
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-12-08 12:29:47" itemprop="dateCreated datePublished" datetime="2023-12-08T12:29:47+08:00">2023-12-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-26 13:00:40" itemprop="dateModified" datetime="2023-12-26T13:00:40+08:00">2023-12-26</time>
    </span>

  
</div>

            <div class="post-description">linux的嵌入式开发第三步，学习linux-ARM相关开发，使用MPU为：I.MX6ULL</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="8-主频和时钟配置"><a href="#8-主频和时钟配置" class="headerlink" title="8. 主频和时钟配置"></a>8. 主频和时钟配置</h2><h3 id="8-1-基本流程"><a href="#8-1-基本流程" class="headerlink" title="8.1. 基本流程"></a>8.1. 基本流程</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1-》主频修改</span><br><span class="line">	1-》目标：ARM内核主频528MHz</span><br><span class="line">	2-》步骤：</span><br><span class="line">		1-》CACRR寄存器ARM_PODF(bit3-0)2分频(可设置1-8分频)</span><br><span class="line">		2-》PLL1有两路=1056MHz，pll1_main_clk和step_clk</span><br><span class="line">			1-》CCSR寄存器pll1_sw_clk_sel(bit2)切换pll1_main_clk和step_clk</span><br><span class="line">			2-》修改时需要一个临时时钟，此时CCSR切换为step_clk</span><br><span class="line">			3-》step_clk有两路，osc_clk和其他</span><br><span class="line">				1-》CCSR寄存器step_sel(bit8)切换为osc_clk</span><br><span class="line">				2-》修改时需要一个临时时钟，此时CCSR切换为step_clk</span><br><span class="line">		3-》CCM_ANALOG_PLL_ARM寄存器ENABLE(bit13)使能时钟输出，DIV_SELECT(bit6-0)设置PLL1主频</span><br><span class="line">			目标频率 = OSC主频*（DIV_SEL/2） -&gt;	1056 = 24*（DIV_SEL/2）-&gt; DIV_SEL=88</span><br><span class="line">		4-》修改完成需要切换回主时钟时钟，此时CCSR切换为pll1_main_clk</span><br><span class="line">2-》PLL时钟配置</span><br><span class="line">	1-》目标：PLL2-528MHz</span><br><span class="line">		1-》初始化PLL2_PFD0-PFD3，在CCM_ANALOG_PFD_528n寄存器设置</span><br><span class="line">	2-》目标：PLL3-480MHz</span><br><span class="line">		1-》初始化PLL3_PFD0-PFD3，在CCM_ANALOG_PFD_480n寄存器设置</span><br><span class="line">3-》其他外设时钟源配置(注意NOTE，是否需要等待握手信号完成)</span><br><span class="line">	1-》AHB_CLK_ROOT=132MHz</span><br><span class="line">		1-》CBCMR寄存器	PRE_PERIPH_CLK_SEL(bit19-18)-&gt;选择PLL2_PFD2</span><br><span class="line">		2-》CBCDR寄存器 PERIPH_CLK_SEL(bit25) AHB_PODF(bit12-10)</span><br><span class="line">	2-》PERCLK_CLK_ROOT=66MHz</span><br><span class="line">	3-》IPG_CLK_ROOT=66MHz</span><br></pre></td></tr></table></figure>

<h3 id="8-2-代码编写"><a href="#8-2-代码编写" class="headerlink" title="8.2. 代码编写"></a>8.2. 代码编写</h3><h4 id="bsp-clk-c"><a href="#bsp-clk-c" class="headerlink" title="bsp_clk.c"></a>bsp_clk.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_clk.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 使能I.MX6U所有外设时钟</span></span><br><span class="line"><span class="comment"> * @param 		: 无</span></span><br><span class="line"><span class="comment"> * @return 		: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">clk_enable</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	CCM-&gt;CCGR0 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">	CCM-&gt;CCGR1 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">	CCM-&gt;CCGR2 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">	CCM-&gt;CCGR3 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">	CCM-&gt;CCGR4 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">	CCM-&gt;CCGR5 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">	CCM-&gt;CCGR6 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">imx6ull_clk_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> reg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//切換爲臨時時鐘</span></span><br><span class="line">	<span class="keyword">if</span> (((CCM-&gt;CCSR&gt;&gt;<span class="number">2</span>)&amp;<span class="number">0x1</span>) == <span class="number">0</span>) <span class="comment">//如果當前PLL1使用的clk爲pll1_main_clk</span></span><br><span class="line">	&#123;</span><br><span class="line">		CCM-&gt;CCSR &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">8</span>);	<span class="comment">//設置step_clk使用osc_clk=24Mhz</span></span><br><span class="line">		CCM-&gt;CCSR |= (<span class="number">1</span>&lt;&lt;<span class="number">2</span>);	<span class="comment">//設置PLL1使用的clk爲step_clk</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//修改時鐘主頻</span></span><br><span class="line">	CCM_ANALOG-&gt;PLL_ARM |= (<span class="number">1</span>&lt;&lt;<span class="number">13</span>) | ((<span class="number">88</span>&lt;&lt;<span class="number">0</span>)&amp;<span class="number">0x7f</span>);	<span class="comment">//使能時鐘輸出並且設置DIV_SELECT=88</span></span><br><span class="line">	CCM-&gt;CCSR |= (<span class="number">1</span>&lt;&lt;<span class="number">0</span>);			<span class="comment">//設置2分頻</span></span><br><span class="line">	CCM-&gt;CCSR &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">2</span>);			<span class="comment">//切換回pll1_main_clk</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		PLL2和PLL3初始化</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	reg = CCM_ANALOG-&gt;PFD_528;</span><br><span class="line">	reg &amp;= ~(<span class="number">0x3f3f3f3f</span>);</span><br><span class="line">	reg |= (<span class="number">32</span>&lt;&lt;<span class="number">24</span>);		<span class="comment">/*PLL2_PFD3=297MHz*/</span></span><br><span class="line">	reg |= (<span class="number">24</span>&lt;&lt;<span class="number">16</span>);		<span class="comment">/*PLL2_PFD2=396MHz*/</span></span><br><span class="line">	reg |= (<span class="number">16</span>&lt;&lt;<span class="number">8</span>);			<span class="comment">/*PLL2_PFD1=594MHz*/</span></span><br><span class="line">	reg |= (<span class="number">27</span>&lt;&lt;<span class="number">0</span>);			<span class="comment">/*PLL2_PFD0=352MHz*/</span></span><br><span class="line">	CCM_ANALOG-&gt;PFD_528 = reg;</span><br><span class="line"></span><br><span class="line">	reg = <span class="number">0</span>;</span><br><span class="line">	reg = CCM_ANALOG-&gt;PFD_480;</span><br><span class="line">	reg &amp;= ~(<span class="number">0x3f3f3f3f</span>);</span><br><span class="line">	reg |= (<span class="number">19</span>&lt;&lt;<span class="number">24</span>);		<span class="comment">/*PLL2_PFD3=454.7MHz*/</span></span><br><span class="line">	reg |= (<span class="number">17</span>&lt;&lt;<span class="number">16</span>);		<span class="comment">/*PLL2_PFD2=508.2MHz*/</span></span><br><span class="line">	reg |= (<span class="number">16</span>&lt;&lt;<span class="number">8</span>);			<span class="comment">/*PLL2_PFD1=540MHz*/</span></span><br><span class="line">	reg |= (<span class="number">12</span>&lt;&lt;<span class="number">0</span>);			<span class="comment">/*PLL2_PFD0=720MHz*/</span></span><br><span class="line">	CCM_ANALOG-&gt;PFD_480 = reg;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 4、设置AHB时钟 最小6Mhz， 最大132Mhz (boot rom自动设置好了可以不用设置)*/</span></span><br><span class="line">	CCM-&gt;CBCMR &amp;= ~(<span class="number">3</span> &lt;&lt; <span class="number">18</span>); 	<span class="comment">/* 清除设置*/</span> </span><br><span class="line">	CCM-&gt;CBCMR |= (<span class="number">1</span> &lt;&lt; <span class="number">18</span>);	<span class="comment">/* pre_periph_clk=PLL2_PFD2=396MHz */</span></span><br><span class="line">	CCM-&gt;CBCDR &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">25</span>);	<span class="comment">/* periph_clk=pre_periph_clk=396MHz */</span></span><br><span class="line">	<span class="keyword">while</span>(CCM-&gt;CDHIPR &amp; (<span class="number">1</span> &lt;&lt; <span class="number">5</span>));<span class="comment">/* 等待握手完成 */</span></span><br><span class="line">		</span><br><span class="line">	<span class="comment">/* 修改AHB_PODF位的时候需要先禁止AHB_CLK_ROOT的输出，但是</span></span><br><span class="line"><span class="comment">	 * 我没有找到关闭AHB_CLK_ROOT输出的的寄存器，所以就没法设置。</span></span><br><span class="line"><span class="comment">	 * 下面设置AHB_PODF的代码仅供学习参考不能直接拿来使用！！</span></span><br><span class="line"><span class="comment">	 * 内部boot rom将AHB_PODF设置为了3分频，即使我们不设置AHB_PODF，</span></span><br><span class="line"><span class="comment">	 * AHB_ROOT_CLK也依旧等于396/3=132Mhz。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	<span class="comment">/* 要先关闭AHB_ROOT_CLK输出，否则时钟设置会出错 */</span></span><br><span class="line">	CCM-&gt;CBCDR &amp;= ~(<span class="number">7</span> &lt;&lt; <span class="number">10</span>);	<span class="comment">/* CBCDR的AHB_PODF清零 */</span></span><br><span class="line">	CCM-&gt;CBCDR |= <span class="number">2</span> &lt;&lt; <span class="number">10</span>;		<span class="comment">/* AHB_PODF 3分频，AHB_CLK_ROOT=132MHz */</span></span><br><span class="line">	<span class="keyword">while</span>(CCM-&gt;CDHIPR &amp; (<span class="number">1</span> &lt;&lt; <span class="number">1</span>));/</span><br><span class="line">* 等待握手完成 */</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 5、设置IPG_CLK_ROOT最小3Mhz，最大66Mhz (boot rom自动设置好了可以不用设置)*/</span></span><br><span class="line">	CCM-&gt;CBCDR &amp;= ~(<span class="number">3</span> &lt;&lt; <span class="number">8</span>);	<span class="comment">/* CBCDR的IPG_PODF清零 */</span></span><br><span class="line">	CCM-&gt;CBCDR |= <span class="number">1</span> &lt;&lt; <span class="number">8</span>;		<span class="comment">/* IPG_PODF 2分频，IPG_CLK_ROOT=66MHz */</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 6、设置PERCLK_CLK_ROOT时钟 */</span></span><br><span class="line">	CCM-&gt;CSCMR1 &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">6</span>);	<span class="comment">/* PERCLK_CLK_ROOT时钟源为IPG */</span></span><br><span class="line">	CCM-&gt;CSCMR1 &amp;= ~(<span class="number">7</span> &lt;&lt; <span class="number">0</span>);	<span class="comment">/* PERCLK_PODF位清零，即1分频 */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="9-GPIO中断"><a href="#9-GPIO中断" class="headerlink" title="9. GPIO中断"></a>9. GPIO中断</h2><h3 id="9-1-中断相关"><a href="#9-1-中断相关" class="headerlink" title="9.1. 中断相关"></a>9.1. 中断相关</h3><h4 id="中断向量表"><a href="#中断向量表" class="headerlink" title="中断向量表"></a>中断向量表</h4><p>IRQ外部中断(<em><strong>重点</strong></em>)</p>
<h4 id="中断向量偏移"><a href="#中断向量偏移" class="headerlink" title="中断向量偏移"></a>中断向量偏移</h4><h4 id="GIC中断控制器"><a href="#GIC中断控制器" class="headerlink" title="GIC中断控制器"></a>GIC中断控制器</h4><h4 id="IMX6U中断ID"><a href="#IMX6U中断ID" class="headerlink" title="IMX6U中断ID"></a>IMX6U中断ID</h4><p>SPI中断：ID0-15</p>
<p>PPI中断：ID16-31</p>
<p>SGI中断：ID32-1019</p>
<h3 id="9-2-基本流程"><a href="#9-2-基本流程" class="headerlink" title="9.2. 基本流程"></a>9.2. 基本流程</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1-》添加中断向量表，编写复位中断和外部中断服务函数</span><br><span class="line">	1-》复位中断服务函数</span><br><span class="line">		1-》关闭I,D cache和MMU，禁止分支预测</span><br><span class="line">			修改SCTLR寄存器(CP15协处理器管理的寄存器之一)---读-&gt;改-&gt;写</span><br><span class="line">		2-》设置中断向量偏移</span><br><span class="line">			修改VBAR寄存器(CP15协处理器管理的寄存器之一)</span><br><span class="line">		3-》设置9钟模式下的SP指针</span><br><span class="line">		4-》清除bss段</span><br><span class="line">		5-》跳到main</span><br><span class="line">	2-》IRQ中断服务函数</span><br><span class="line">		1-》中断环境保存入栈(lr, r0-r3,r12, spsr)</span><br><span class="line">		2-》执行对应触发的中断函数</span><br><span class="line">			1-》读取GIC的CBAR寄存器,加0x2000得到cpu接口基地址,加0x000C得到GIC的IAR寄存器地址</span><br><span class="line">				GICC_IAR寄存器中存储中断ID，调用函数就是根据中断ID调用</span><br><span class="line">				保存cpu接口基地址和IAR寄存器的值</span><br><span class="line">			2-》进入svc模式后，保存lr，调用函数，弹出lr，重新进入IRQ模式</span><br><span class="line">				弹出cpu接口基地址和IAR寄存器的值</span><br><span class="line">			3-》将中断ID写入GICC_EOIR寄存器</span><br><span class="line">			4-》恢复spsr寄存器状态</span><br><span class="line">			5-》将lr-4赋值pc，结束中断服务</span><br><span class="line">2-》通用中断函数编写</span><br><span class="line">3-》GPIO中断设置</span><br><span class="line">	1-》设置中断触发方式-设置GPIO_ICR寄存器</span><br><span class="line">	2-》使能GPIO中断-设置GPIO_IMR</span><br><span class="line">	3-》中断完成后清除中断标志位-设置GPIO_ISR(写1清零)</span><br><span class="line">4-》GIC设置</span><br><span class="line">	1-》使能相应的中断ID(注意+32跳过前面的SPI和PPI中断)</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<h3 id="9-3-代码编写"><a href="#9-3-代码编写" class="headerlink" title="9.3.代码编写"></a>9.3.代码编写</h3><h4 id="bsp-int-h"><a href="#bsp-int-h" class="headerlink" title="bsp_int.h"></a>bsp_int.h</h4><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BSP_INT_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BSP_INT_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定義中斷處理函數</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">system_irq_handler_t</span>)</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> gicciar, <span class="type">void</span> * param)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">sys_irq_handler</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">system_irq_handler_t</span> irqHandler;<span class="comment">//中斷處理函數</span></span><br><span class="line">    <span class="type">void</span> * userParam;       <span class="comment">//中斷處理函數的參數</span></span><br><span class="line">&#125; <span class="type">sys_irq_handler_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">int_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">system_irqtable_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">default_irqhandler</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> gicciar, <span class="type">void</span> *userParam)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">system_irqhandler</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> gicciar)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">system_register_irqhandler</span><span class="params">(IRQn_Type irq, <span class="type">system_irq_handler_t</span> handler, <span class="type">void</span> *userParam)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !__BSP_INT_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bsp-int-c"><a href="#bsp-int-c" class="headerlink" title="bsp_int.c"></a>bsp_int.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_int.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//中斷嵌套計數器</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> irqNesting;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中斷向量處理表</span></span><br><span class="line"><span class="type">static</span> <span class="type">sys_irq_handler_t</span> irqTable[NUMBER_OF_INT_VECTORS];</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始中斷向量處理表</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">system_irqtable_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    irqNesting = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUMBER_OF_INT_VECTORS; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        irqTable[i].irqHandler = default_irqhandler;</span><br><span class="line">        irqTable[i].userParam = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//註冊中斷處理</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">system_register_irqhandler</span><span class="params">(IRQn_Type irq, <span class="type">system_irq_handler_t</span> handler, <span class="type">void</span> *userParam)</span>&#123;</span><br><span class="line">    irqTable[irq].irqHandler = handler;</span><br><span class="line">    irqTable[irq].userParam = userParam;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">int_init</span><span class="params">()</span>&#123;</span><br><span class="line">    GIC_Init();<span class="comment">//GIC初始化</span></span><br><span class="line">    system_irqtable_init();<span class="comment">//中斷向量表初始化</span></span><br><span class="line">    __set_VBAR((<span class="type">uint32_t</span>)<span class="number">0x87800000</span>);<span class="comment">//設置中斷向量偏移</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//具體中斷函數,IRQ_Handler調用</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">system_irqhandler</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> gicciar)</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> intNum = gicciar &amp; <span class="number">0x3ff</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//檢查中斷ID是否合法</span></span><br><span class="line">    <span class="keyword">if</span> ((intNum == <span class="number">1020</span>) || (intNum &gt;= NUMBER_OF_INT_VECTORS))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    irqNesting++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根據中斷ID，獲得中斷處理函數S</span></span><br><span class="line">    irqTable[intNum].irqHandler(intNum, irqTable[intNum].userParam);</span><br><span class="line"></span><br><span class="line">    irqNesting--;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">default_irqhandler</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> gicciar, <span class="type">void</span> *userParam)</span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bsp-exti-h"><a href="#bsp-exti-h" class="headerlink" title="bsp_exti.h"></a>bsp_exti.h</h4><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BSP_EXTI_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BSP_EXTI_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exti_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio1_io18_irqhandler</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !__BSP_EXTI_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bsp-exti-c"><a href="#bsp-exti-c" class="headerlink" title="bsp_exti.c"></a>bsp_exti.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_exti.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_gpio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_beep.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_int.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exti_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">gpio_pin_config_t</span> key_config;</span><br><span class="line">    <span class="comment">//設置IO復用</span></span><br><span class="line">    IOMUXC_SetPinMux(IOMUXC_UART1_CTS_B_GPIO1_IO18, <span class="number">0</span>);</span><br><span class="line">    IOMUXC_SetPinConfig(IOMUXC_UART1_CTS_B_GPIO1_IO18, <span class="number">0xf080</span>);</span><br><span class="line">    <span class="comment">//設置IO輸入輸出模式\中斷模式</span></span><br><span class="line">    key_config.direction = kGPIO_DigitalInput;</span><br><span class="line">    key_config.interruptMode = kGPIO_IntFallingEdge;</span><br><span class="line">    key_config.outputLogic = <span class="number">1</span>;</span><br><span class="line">    gpio_init(GPIO1, <span class="number">18</span>, &amp;key_config);</span><br><span class="line">    <span class="comment">//使能GIC中斷\註冊中斷函數\使能IO中斷</span></span><br><span class="line">    GIC_EnableIRQ(GPIO1_Combined_16_31_IRQn);   <span class="comment">//IO18</span></span><br><span class="line">    system_register_irqhandler(GPIO1_Combined_16_31_IRQn, (<span class="type">system_irq_handler_t</span>)gpio1_io18_irqhandler, <span class="literal">NULL</span>);</span><br><span class="line">    gpio_enableint(GPIO1, <span class="number">18</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio1_io18_irqhandler</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> state = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *采用延时消抖，中断服务函数中禁止使用延时函数！因为中断服务需要</span></span><br><span class="line"><span class="comment">    *快进快出！！这里为了演示所以采用了延时函数进行消抖，后面我们会讲解</span></span><br><span class="line"><span class="comment">    *定时器中断消抖法！！！</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    delay(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gpio_pinread(GPIO1, <span class="number">18</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        state = !state;</span><br><span class="line">        beep_switch(state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gpio_clearintflags(GPIO1, <span class="number">18</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bsp-gpio-h"><a href="#bsp-gpio-h" class="headerlink" title="bsp_gpio.h"></a>bsp_gpio.h</h4><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BSP_GPIO_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BSP_GPIO_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fsl_iomuxc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MCIMX6Y2.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    GPIO中斷類型枚舉</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">gpio_interrupt_mode</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    kGPIO_NoIntmode = <span class="number">0U</span>,               <span class="comment">//無中斷</span></span><br><span class="line">    kGPIO_IntLowLevel = <span class="number">1U</span>,             <span class="comment">//低電平觸發</span></span><br><span class="line">    kGPIO_IntHighLevel = <span class="number">2U</span>,            <span class="comment">//高電平觸發</span></span><br><span class="line">    kGPIO_IntRisingEdge = <span class="number">3U</span>,           <span class="comment">//上升沿觸發</span></span><br><span class="line">    kGPIO_IntFallingEdge = <span class="number">4U</span>,          <span class="comment">//下降沿觸發</span></span><br><span class="line">    kGPIO_IntFallingOrRisingEdge = <span class="number">5U</span>,  <span class="comment">//上升沿或下降沿觸發</span></span><br><span class="line">&#125; <span class="type">gpio_interrupt_mode_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    枚舉類型與結構體定義</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">gpio_pin_direction</span>&#123;</span></span><br><span class="line">    kGPIO_DigitalInput = <span class="number">0</span>,</span><br><span class="line">    kGPIO_DigitalOutput = <span class="number">1</span>,</span><br><span class="line">&#125; <span class="type">gpio_pin_direction_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">gpio_pin_config</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">gpio_pin_direction_t</span> direction; <span class="comment">//GPIO方向：輸入/輸出</span></span><br><span class="line">    <span class="type">uint8_t</span> outputLogic;            <span class="comment">//默認輸出電平</span></span><br><span class="line">    <span class="type">gpio_interrupt_mode_t</span> interruptMode;   <span class="comment">//中斷模式</span></span><br><span class="line">&#125; <span class="type">gpio_pin_config_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函數聲明</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_init</span><span class="params">(GPIO_Type *base, <span class="type">int</span> pin, <span class="type">gpio_pin_config_t</span> *config)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">gpio_pinread</span><span class="params">(GPIO_Type *base, <span class="type">int</span> pin)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_pinwrite</span><span class="params">(GPIO_Type *base, <span class="type">int</span> pin, <span class="type">int</span> value)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_intconfig</span><span class="params">(GPIO_Type *base, <span class="type">unsigned</span> <span class="type">int</span> pin, <span class="type">gpio_interrupt_mode_t</span> pin_int_mode)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_enableint</span><span class="params">(GPIO_Type *base, <span class="type">unsigned</span> <span class="type">int</span> pin)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_disableint</span><span class="params">(GPIO_Type *base, <span class="type">unsigned</span> <span class="type">int</span> pin)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_clearintflags</span><span class="params">(GPIO_Type *base, <span class="type">unsigned</span> <span class="type">int</span> pin)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !__BSP_GPIO_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bsp-gpio-c"><a href="#bsp-gpio-c" class="headerlink" title="bsp_gpio.c"></a>bsp_gpio.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_gpio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_init</span><span class="params">(GPIO_Type *base, <span class="type">int</span> pin, <span class="type">gpio_pin_config_t</span> *config)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (config-&gt;direction == kGPIO_DigitalInput)</span><br><span class="line">    &#123;</span><br><span class="line">        base-&gt;GDIR &amp;= ~(<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(config-&gt;direction == kGPIO_DigitalOutput)</span><br><span class="line">    &#123;</span><br><span class="line">        base-&gt;GDIR |= (<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            設置默認輸出電平</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       gpio_pinwrite(base, pin, config-&gt;outputLogic);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    gpio_intconfig(base, pin, config-&gt;interruptMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpio_pinread</span><span class="params">(GPIO_Type *base, <span class="type">int</span> pin)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((base-&gt;DR &gt;&gt; pin) &amp;<span class="number">0x1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_pinwrite</span><span class="params">(GPIO_Type *base, <span class="type">int</span> pin, <span class="type">int</span> value)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="number">0U</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        base-&gt;DR &amp;= ~(<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (value == <span class="number">1U</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        base-&gt;DR |= (<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_intconfig</span><span class="params">(GPIO_Type *base, <span class="type">unsigned</span> <span class="type">int</span> pin, <span class="type">gpio_interrupt_mode_t</span> pin_int_mode)</span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">uint32_t</span> *icr;</span><br><span class="line">    <span class="type">uint32_t</span> icrShift;</span><br><span class="line">    icrShift = pin;</span><br><span class="line"></span><br><span class="line">    base-&gt;EDGE_SEL &amp;= ~(<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (icrShift &lt; <span class="number">16</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        icr = &amp;(base-&gt;ICR1);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        icr = &amp;(base-&gt;ICR2);</span><br><span class="line">        icrShift -= <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (pin_int_mode)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> kGPIO_IntLowLevel:</span><br><span class="line">            *icr &amp;= ~(<span class="number">3U</span> &lt;&lt; <span class="number">2</span>*icrShift);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kGPIO_IntHighLevel:</span><br><span class="line">            *icr &amp;= ~(<span class="number">3U</span> &lt;&lt; <span class="number">2</span>*icrShift);</span><br><span class="line">            *icr |= (<span class="number">1U</span> &lt;&lt; <span class="number">2</span>*icrShift);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kGPIO_IntRisingEdge:</span><br><span class="line">            *icr &amp;= ~(<span class="number">3U</span> &lt;&lt; <span class="number">2</span>*icrShift);</span><br><span class="line">            *icr |= (<span class="number">2U</span> &lt;&lt; <span class="number">2</span>*icrShift);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kGPIO_IntFallingEdge:</span><br><span class="line">            *icr &amp;= ~(<span class="number">3U</span> &lt;&lt; <span class="number">2</span>*icrShift);</span><br><span class="line">            *icr |= (<span class="number">3U</span> &lt;&lt; <span class="number">2</span>*icrShift);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kGPIO_IntFallingOrRisingEdge:</span><br><span class="line">            base-&gt;EDGE_SEL |= (<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使能中斷</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_enableint</span><span class="params">(GPIO_Type *base, <span class="type">unsigned</span> <span class="type">int</span> pin)</span>&#123;</span><br><span class="line">    base-&gt;IMR |= (<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//禁止中斷s</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_disableint</span><span class="params">(GPIO_Type *base, <span class="type">unsigned</span> <span class="type">int</span> pin)</span>&#123;</span><br><span class="line">    base-&gt;IMR &amp;= ~(<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//清除中斷標誌位</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_clearintflags</span><span class="params">(GPIO_Type *base, <span class="type">unsigned</span> <span class="type">int</span> pin)</span>&#123;</span><br><span class="line">    base-&gt;ISR |= (<span class="number">1</span>&lt;&lt;pin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-4-问题解决"><a href="#9-4-问题解决" class="headerlink" title="9.4. 问题解决"></a>9.4. 问题解决</h3><h4 id="添加GPIO中断后代码卡死"><a href="#添加GPIO中断后代码卡死" class="headerlink" title="添加GPIO中断后代码卡死"></a>添加GPIO中断后代码卡死</h4><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">加入中断后，中断偏移向量设置为0x87800000</span><br><span class="line">但是，由于增加了清除bss段的设置，实际上0x87800000存放的是__bss_start，0x87800004存放的是__bss_end，而0x87800008存放的才是中断向量表</span><br><span class="line">所以代码会卡死，因为中断向量全部混乱</span><br></pre></td></tr></table></figure>

<h5 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h5><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">方法一：尝试将中断向量的偏移设置为0x87800008，但是依旧没有效果</span><br><span class="line">方法二：删除bss清除代码，即可执行</span><br><span class="line">方法三：将bss清除代码的定义放到中断向量表之后即可</span><br></pre></td></tr></table></figure>

<h2 id="10-EPIT定时器"><a href="#10-EPIT定时器" class="headerlink" title="10. EPIT定时器"></a>10. EPIT定时器</h2><h3 id="10-1-基本流程"><a href="#10-1-基本流程" class="headerlink" title="10.1. 基本流程"></a>10.1. 基本流程</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1-》EPIT_CR寄存器</span><br><span class="line">	1-》bit25:24 - CLKSRC 设置EPIT时钟源</span><br><span class="line">	2-》bit15:4  - PRESCALAR 设置分频值</span><br><span class="line">	3-》bit3		- RLD 设置工作模式</span><br><span class="line">	4-》bit1		- ENMOD 设置初始值来源</span><br><span class="line">	5-》bit2		- OCIEN 使能比较中断</span><br><span class="line">2-》EPIT_LR寄存器</span><br><span class="line">	1-》 设置加载值</span><br><span class="line">3-》EPIT_CMPR寄存器</span><br><span class="line">	1-》 设置比较值</span><br><span class="line">4-》中断相关</span><br><span class="line">	1-》使能GIC中EPIT1中断</span><br><span class="line">	2-》注册中断服务函数</span><br><span class="line">	3-》设置中断优先级</span><br><span class="line">	4-》中断函数编写</span><br><span class="line">5-》使能EPIT定时器</span><br><span class="line">	6-》bit0		- EPIT_CR寄存器 EN 使能EPIT</span><br></pre></td></tr></table></figure>

<h3 id="10-2-代码编写"><a href="#10-2-代码编写" class="headerlink" title="10.2. 代码编写"></a>10.2. 代码编写</h3><h4 id="bsp-epit-h"><a href="#bsp-epit-h" class="headerlink" title="bsp_epit.h"></a>bsp_epit.h</h4><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BSP_EPIT_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BSP_EPIT_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">epit1_init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> frac, <span class="type">unsigned</span> <span class="type">int</span> value)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">epit1_irqhandler</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !__BSP_EPIT_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bsp-epit-c"><a href="#bsp-epit-c" class="headerlink" title="bsp_epit.c"></a>bsp_epit.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_epit.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_int.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_led.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">epit1_init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> frac, <span class="type">unsigned</span> <span class="type">int</span> value)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (frac &gt; <span class="number">0xfff</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        frac = <span class="number">0xfff</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    EPIT1-&gt;CR = <span class="number">0x0</span>;    <span class="comment">//初始化清零寄存器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * CR 寄存器:</span></span><br><span class="line"><span class="comment">        * bit25:24 01 时钟源选择 Peripheral clock=66MHz</span></span><br><span class="line"><span class="comment">        * bit15:4 frac 分频值</span></span><br><span class="line"><span class="comment">        * bit3: 1 当计数器到 0 的话从 LR 重新加载数值</span></span><br><span class="line"><span class="comment">        * bit2: 1 比较中断使能</span></span><br><span class="line"><span class="comment">        * bit1: 1 初始计数值来源于 LR 寄存器值</span></span><br><span class="line"><span class="comment">        * bit0: 0 先关闭 EPIT1</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    EPIT1-&gt;CR = (<span class="number">0x1</span>&lt;&lt;<span class="number">24</span>) | (frac&lt;&lt;<span class="number">4</span>) | (<span class="number">0x1</span>&lt;&lt;<span class="number">3</span>) | (<span class="number">0x1</span>&lt;&lt;<span class="number">2</span>) | (<span class="number">0x1</span>&lt;&lt;<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    EPIT1-&gt;LR = value;  <span class="comment">//加載寄存器的值</span></span><br><span class="line">    EPIT1-&gt;CMPR = <span class="number">0</span>;    <span class="comment">//與0比較，相當於倒計時到0發生中斷</span></span><br><span class="line"></span><br><span class="line">    GIC_EnableIRQ(EPIT1_IRQn);</span><br><span class="line">    system_register_irqhandler(EPIT1_IRQn, (<span class="type">system_irq_handler_t</span>)epit1_irqhandler, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    EPIT1-&gt;CR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);  <span class="comment">//使能EPIT</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">epit1_irqhandler</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> state = <span class="number">0</span>;</span><br><span class="line">    state = !state;</span><br><span class="line">    <span class="keyword">if</span> (EPIT1-&gt;SR &amp; (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        led_switch(LED0, state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EPIT1-&gt;SR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-按键消抖"><a href="#11-按键消抖" class="headerlink" title="11. 按键消抖"></a>11. 按键消抖</h2><h3 id="11-1-代码编写"><a href="#11-1-代码编写" class="headerlink" title="11.1. 代码编写"></a>11.1. 代码编写</h3><h4 id="bsp-keyfilter-h"><a href="#bsp-keyfilter-h" class="headerlink" title="bsp_keyfilter.h"></a>bsp_keyfilter.h</h4><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BSP_KEYFILTER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BSP_KEYFILTER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">keyfilter_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">filtertimer_init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">filtertimer_stop</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">filtertimer_restart</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">filtertimer_irqhandler</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_16_31_irqhandler</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !__BSP_KEYFILTER_H</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bsp-keyfilter-c"><a href="#bsp-keyfilter-c" class="headerlink" title="bsp_keyfilter.c"></a>bsp_keyfilter.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_keyfilter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_gpio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_int.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_beep.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">keyfilter_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">gpio_pin_config_t</span> key_config;</span><br><span class="line">    <span class="comment">//1.IO初始化</span></span><br><span class="line">    IOMUXC_SetPinMux(IOMUXC_UART1_CTS_B_GPIO1_IO18, <span class="number">0</span>);</span><br><span class="line">    IOMUXC_SetPinConfig(IOMUXC_UART1_CTS_B_GPIO1_IO18, <span class="number">0xf080</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.中斷初始化</span></span><br><span class="line">    key_config.direction = kGPIO_DigitalInput;</span><br><span class="line">    key_config.interruptMode = kGPIO_IntFallingEdge;</span><br><span class="line">    key_config.outputLogic = <span class="number">1</span>;</span><br><span class="line">    gpio_init(GPIO1, <span class="number">18</span>, &amp;key_config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.使能GPIO並註冊中斷</span></span><br><span class="line">    GIC_EnableIRQ(GPIO1_Combined_16_31_IRQn);</span><br><span class="line">    system_register_irqhandler(GPIO1_Combined_16_31_IRQn, (<span class="type">system_irq_handler_t</span>)gpio_16_31_irqhandler, <span class="literal">NULL</span>);</span><br><span class="line">    gpio_enableint(GPIO1, <span class="number">18</span>);  <span class="comment">//開啓gpio中斷</span></span><br><span class="line">    filtertimer_init(<span class="number">66000000</span>/<span class="number">100</span>); <span class="comment">//初始化定時器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">filtertimer_init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value)</span>&#123;</span><br><span class="line">    EPIT1-&gt;CR = <span class="number">0x0</span>;   <span class="comment">//先清零</span></span><br><span class="line">    EPIT1-&gt;CR = (<span class="number">0x1</span>&lt;&lt;<span class="number">24</span>)|(<span class="number">0x1</span>&lt;&lt;<span class="number">3</span>)|(<span class="number">0x1</span>&lt;&lt;<span class="number">2</span>)|(<span class="number">0x1</span>&lt;&lt;<span class="number">1</span>);</span><br><span class="line">    EPIT1-&gt;LR = value;</span><br><span class="line">    EPIT1-&gt;CMPR = <span class="number">0</span>;</span><br><span class="line">    GIC_EnableIRQ(EPIT1_IRQn);</span><br><span class="line">    system_register_irqhandler(EPIT1_IRQn, (<span class="type">system_irq_handler_t</span>)filtertimer_irqhandler, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//關閉定時器</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">filtertimer_stop</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EPIT1-&gt;CR &amp;= ~(<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//開啓定時器</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">filtertimer_restart</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value)</span>&#123;</span><br><span class="line">    EPIT1-&gt;CR &amp;= ~(<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>); <span class="comment">//先關閉定時器</span></span><br><span class="line">    EPIT1-&gt;LR = value;</span><br><span class="line">    EPIT1-&gt;CR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);  <span class="comment">//再開啓定時器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">filtertimer_irqhandler</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> state = OFF;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (EPIT1-&gt;SR &amp;(<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        filtertimer_stop(); <span class="comment">//關閉定時器</span></span><br><span class="line">        <span class="keyword">if</span> (gpio_pinread(GPIO1, <span class="number">18</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            state = !state;</span><br><span class="line">            beep_switch(state);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EPIT1-&gt;SR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);      <span class="comment">//清除中斷標誌位</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_16_31_irqhandler</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    filtertimer_restart(<span class="number">66000000</span>/<span class="number">100</span>);      <span class="comment">//開啓定時器</span></span><br><span class="line">    gpio_clearintflags(GPIO1, <span class="number">18</span>);      <span class="comment">//清除中斷標誌位</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="12-GPT高精度延时"><a href="#12-GPT高精度延时" class="headerlink" title="12. GPT高精度延时"></a>12. GPT高精度延时</h2><h3 id="12-1-基本流程"><a href="#12-1-基本流程" class="headerlink" title="12.1. 基本流程"></a>12.1. 基本流程</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1-》设置 GPT1 定时器(CR寄存器)</span><br><span class="line">	1-》SWR(bit15)位来复位寄存器 GPT1</span><br><span class="line">	2-》CLKSRC(bit8:6)位，选择 GPT1 的时钟源为 ipg_clk3</span><br><span class="line">	3-》FRR(bit9)，设置工作模式</span><br><span class="line">2-》设置 GPT1 的分频值</span><br><span class="line">	设置寄存器 GPT1_PR 寄存器的 PRESCALAR(bit111:0)位，设置分频值</span><br><span class="line">3-》设置 GPT1 的比较值</span><br><span class="line">4-》使能GPT1</span><br><span class="line">5-》编写延时函数</span><br></pre></td></tr></table></figure>

<h3 id="12-2-代码编写"><a href="#12-2-代码编写" class="headerlink" title="12.2. 代码编写"></a>12.2. 代码编写</h3><h4 id="bsp-delay-h"><a href="#bsp-delay-h" class="headerlink" title="bsp_delay.h"></a>bsp_delay.h</h4><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BSP_DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BSP_DELAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 函数声明 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> usdelay)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> msdelay)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpt1_irqhandler</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bsp-delay-c"><a href="#bsp-delay-c" class="headerlink" title="bsp_delay.c"></a>bsp_delay.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_int.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_led.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	GPT1-&gt;CR = <span class="number">0</span>;	<span class="comment">//清零GPT1寄存器</span></span><br><span class="line"></span><br><span class="line">	GPT1-&gt;CR = (<span class="number">0x1</span> &lt;&lt; <span class="number">15</span>);	<span class="comment">//設置GPT1軟復位</span></span><br><span class="line">	<span class="keyword">while</span> (GPT1-&gt;CR &amp; (<span class="number">0x1</span>&lt;&lt;<span class="number">15</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//等待復位完成</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		GPT 的 CR 寄存器,GPT 通用设置</span></span><br><span class="line"><span class="comment">			bit22:20 000 输出比较 1 的输出功能关闭，也就是对应的引脚没反应</span></span><br><span class="line"><span class="comment">			bit9: 0 Restart 模式,当 CNT 等于 OCR1 的时候就产生中断</span></span><br><span class="line"><span class="comment">			bit8:6 001 GPT 时钟源选择 ipg_clk=66Mhz</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	GPT1-&gt;CR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	* GPT 的 PR 寄存器， GPT 的分频设置</span></span><br><span class="line"><span class="comment">	* 	bit11:0 设置分频值，设置为 0 表示 1 分频，</span></span><br><span class="line"><span class="comment">	* 	以此类推，最大可以设置为 0XFFF，也就是最大 4096 分频</span></span><br><span class="line"><span class="comment">   	*/</span></span><br><span class="line">    GPT1-&gt;PR = <span class="number">65</span>;	<span class="comment">//設置爲66分頻，66Mhz/66=1Mhz</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		GPT 的 OCR1 寄存器， GPT 的输出比较 1 比较计数值，</span></span><br><span class="line"><span class="comment">		GPT 的时钟为 1Mz，那么计数器每计一个值就是就是 1us。</span></span><br><span class="line"><span class="comment">		为了实现较大的计数，我们将比较值设置为最大的 0XFFFFFFFF,</span></span><br><span class="line"><span class="comment">		这样一次计满就是： 0XFFFFFFFFus = 4294967296us = 4295s = 71.5min</span></span><br><span class="line"><span class="comment">		也就是说一次计满最多 71.5 分钟，存在溢出。</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	GPT1-&gt;OCR[<span class="number">0</span>] = <span class="number">0xffffffff</span>;</span><br><span class="line">	GPT1-&gt;CR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);	<span class="comment">//使能GPT1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	GPT1-&gt;PR = <span class="number">65</span>;</span><br><span class="line">	GPT1-&gt;OCR[<span class="number">0</span>] = <span class="number">1000000</span>/<span class="number">2</span>;	<span class="comment">//計時500ms</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//使能輸出比較中斷(通道1)</span></span><br><span class="line">	GPT1-&gt;CR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);</span><br><span class="line">	GIC_EnableIRQ(GPT1_IRQn);</span><br><span class="line">	system_register_irqhandler(GPT1_IRQn, (<span class="type">system_irq_handler_t</span>)gpt1_irqhandler, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpt1_irqhandler</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> state=<span class="number">0</span>;</span><br><span class="line">	state = !state;</span><br><span class="line">	<span class="keyword">if</span> (GPT1-&gt;SR &amp; (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		led_switch(LED0, state);</span><br><span class="line">	&#125;</span><br><span class="line">	GPT1-&gt;SR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);	<span class="comment">//清除中斷標誌位</span></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> usdelay)</span>&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> oldcnt,newcnt;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> tcntvalue=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	oldcnt = GPT1-&gt;CNT;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		newcnt=GPT1-&gt;CNT;</span><br><span class="line">		<span class="keyword">if</span> (newcnt != oldcnt)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (newcnt &gt; oldcnt)</span><br><span class="line">			&#123;</span><br><span class="line">				tcntvalue += newcnt-oldcnt;</span><br><span class="line">			&#125;<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				tcntvalue += <span class="number">0xffffffff</span>-oldcnt + newcnt;</span><br><span class="line">			&#125;</span><br><span class="line">			oldcnt = newcnt;</span><br><span class="line">			<span class="keyword">if</span> (tcntvalue &gt;= usdelay)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;			</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> msdelay)</span>&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; msdelay; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		delay_us(<span class="number">1000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/12/04/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91/" rel="prev" title="嵌入式linux入门(三)：linux-ARM裸机一">
                  <i class="fa fa-chevron-left"></i> 嵌入式linux入门(三)：linux-ARM裸机一
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/12/14/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD2/" rel="next" title="嵌入式linux入门(三)：linux-ARM裸机三">
                  嵌入式linux入门(三)：linux-ARM裸机三 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  




  




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"http://example.com/2023/12/08/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD1/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
