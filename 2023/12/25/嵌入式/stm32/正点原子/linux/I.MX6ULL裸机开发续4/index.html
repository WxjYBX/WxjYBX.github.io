<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="linux的嵌入式开发第三步，学习linux-ARM相关开发，使用MPU为：I.MX6ULL">
<meta property="og:type" content="article">
<meta property="og:title" content="嵌入式linux入门(三)：linux-ARM裸机五">
<meta property="og:url" content="http://example.com/2023/12/25/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/linux/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="linux的嵌入式开发第三步，学习linux-ARM相关开发，使用MPU为：I.MX6ULL">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-12-25T06:44:30.407Z">
<meta property="article:modified_time" content="2023-12-26T05:00:19.449Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2023/12/25/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/linux/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2023/12/25/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/linux/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD4/","path":"2023/12/25/嵌入式/stm32/正点原子/linux/I.MX6ULL裸机开发续4/","title":"嵌入式linux入门(三)：linux-ARM裸机五"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>嵌入式linux入门(三)：linux-ARM裸机五 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#18-%E5%A4%9A%E7%82%B9%E7%94%B5%E5%AE%B9%E8%A7%A6%E6%91%B8%E5%B1%8F"><span class="nav-number">1.</span> <span class="nav-text">18. 多点电容触摸屏</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#18-1-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">18.1. 基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">1.2.</span> <span class="nav-text">18.2. 代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-ft5426-h"><span class="nav-number">1.2.1.</span> <span class="nav-text">bsp_ft5426.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-ft5426-c"><span class="nav-number">1.2.2.</span> <span class="nav-text">bsp_ft5426.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-PWM%E8%83%8C%E5%85%89%E8%B0%83%E8%AF%95"><span class="nav-number">2.</span> <span class="nav-text">19. PWM背光调试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#19-1-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">19.1. 基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">2.2.</span> <span class="nav-text">19.2. 代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-backlight-h"><span class="nav-number">2.2.1.</span> <span class="nav-text">bsp_backlight.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bsp-backlight-c"><span class="nav-number">2.2.2.</span> <span class="nav-text">bsp_backlight.c</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/25/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/linux/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="嵌入式linux入门(三)：linux-ARM裸机五 | Hexo">
      <meta itemprop="description" content="linux的嵌入式开发第三步，学习linux-ARM相关开发，使用MPU为：I.MX6ULL">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          嵌入式linux入门(三)：linux-ARM裸机五
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-12-25 14:44:30" itemprop="dateCreated datePublished" datetime="2023-12-25T14:44:30+08:00">2023-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-12-26 13:00:19" itemprop="dateModified" datetime="2023-12-26T13:00:19+08:00">2023-12-26</time>
    </span>

  
</div>

            <div class="post-description">linux的嵌入式开发第三步，学习linux-ARM相关开发，使用MPU为：I.MX6ULL</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="18-多点电容触摸屏"><a href="#18-多点电容触摸屏" class="headerlink" title="18. 多点电容触摸屏"></a>18. 多点电容触摸屏</h2><h3 id="18-1-基本流程"><a href="#18-1-基本流程" class="headerlink" title="18.1. 基本流程"></a>18.1. 基本流程</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1-》初始化引脚</span><br><span class="line">	1-》引脚配置</span><br><span class="line">		I2C2_SCL-&gt;UART5_TXD</span><br><span class="line">     	I2C2_SDA-&gt;UART5_RXD</span><br><span class="line">    2-》初始化触摸屏中断IO和复位IO</span><br><span class="line">    3-》中断函数使能注册</span><br><span class="line">2-》初始化I2C</span><br><span class="line">3-》初始化ft5426</span><br><span class="line">	1-》复位</span><br></pre></td></tr></table></figure>

<h3 id="18-2-代码编写"><a href="#18-2-代码编写" class="headerlink" title="18.2. 代码编写"></a>18.2. 代码编写</h3><h4 id="bsp-ft5426-h"><a href="#bsp-ft5426-h" class="headerlink" title="bsp_ft5426.h"></a>bsp_ft5426.h</h4><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BSP_FT5426_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BSP_FT5426_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 宏定义 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_ADDR				0x38	<span class="comment">/* FT5426设备地址 		*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_DEVICE_MODE		0x00 	<span class="comment">/* 模式寄存器 			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_IDGLIB_VERSION	0xa1 	<span class="comment">/* 固件版本寄存器 			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_IDG_MODE			0xa4	<span class="comment">/* 中断模式				*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_TD_STATUS		0x02	<span class="comment">/* 触摸状态寄存器 			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_TOUCH1_XH		0x03	<span class="comment">/* 触摸点坐标寄存器,</span></span></span><br><span class="line"><span class="comment"><span class="meta">										 * 一个触摸点用4个寄存器存储坐标数据*/</span></span></span><br><span class="line">										 </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_XYCOORDREG_NUM	30		<span class="comment">/* 触摸点坐标寄存器数量 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_INIT_FINISHED	1		<span class="comment">/* 触摸屏初始化完成 			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_INIT_NOTFINISHED	0		<span class="comment">/* 触摸屏初始化未完成 			*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_TOUCH_EVENT_DOWN			0x00	<span class="comment">/* 按下 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_TOUCH_EVENT_UP			0x01	<span class="comment">/* 释放 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_TOUCH_EVENT_ON			0x02	<span class="comment">/* 接触 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_TOUCH_EVENT_RESERVED		0x03	<span class="comment">/* 没有事件 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 触摸屏结构体 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ft5426_dev_struc</span></span></span><br><span class="line"><span class="class">&#123;</span>	</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> initfalg;		<span class="comment">/* 触摸屏初始化状态 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> intflag;		<span class="comment">/* 标记中断有没有发生 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> point_num;	<span class="comment">/* 触摸点 		*/</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> x[<span class="number">5</span>];		<span class="comment">/* X轴坐标 	*/</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> y[<span class="number">5</span>];		<span class="comment">/* Y轴坐标 	*/</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">ft5426_dev_struc</span> <span class="title">ft5426_dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ft5426_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio1_io09_irqhandler</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ft5426_write_byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> reg, <span class="type">unsigned</span> <span class="type">char</span> data)</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ft5426_read_byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> reg)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ft5426_read_len</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> reg, <span class="type">unsigned</span> <span class="type">char</span> len, <span class="type">unsigned</span> <span class="type">char</span> *buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ft5426_read_tpnum</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ft5426_read_tpcoord</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !__BSP_FT5426_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bsp-ft5426-c"><a href="#bsp-ft5426-c" class="headerlink" title="bsp_ft5426.c"></a>bsp_ft5426.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_ft5426.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_gpio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_int.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_i2c.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ft5426_dev_struc</span> <span class="title">ft5426_dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化ft5426</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ft5426_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">/* 1、初始化IIC2 IO</span></span><br><span class="line"><span class="comment">     * I2C2_SCL -&gt; UART5_TXD</span></span><br><span class="line"><span class="comment">     * I2C2_SDA -&gt; UART5_RXD</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IOMUXC_SetPinMux(IOMUXC_UART5_RX_DATA_I2C2_SDA, <span class="number">1</span>);</span><br><span class="line">    IOMUXC_SetPinMux(IOMUXC_UART5_TX_DATA_I2C2_SCL, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置I2C2 IO属性	</span></span><br><span class="line"><span class="comment">	 *bit 16:0 HYS关闭</span></span><br><span class="line"><span class="comment">	 *bit [15:14]: 1 默认47K上拉</span></span><br><span class="line"><span class="comment">	 *bit [13]: 1 pull功能</span></span><br><span class="line"><span class="comment">	 *bit [12]: 1 pull/keeper使能 </span></span><br><span class="line"><span class="comment">	 *bit [11]: 0 关闭开路输出</span></span><br><span class="line"><span class="comment">	 *bit [7:6]: 10 速度100Mhz</span></span><br><span class="line"><span class="comment">	 *bit [5:3]: 110 驱动能力为R0/6</span></span><br><span class="line"><span class="comment">	 *bit [0]: 1 高转换率</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    IOMUXC_SetPinConfig(IOMUXC_UART5_RX_DATA_I2C2_SDA, <span class="number">0x70b0</span>);</span><br><span class="line">    IOMUXC_SetPinConfig(IOMUXC_UART5_TX_DATA_I2C2_SCL, <span class="number">0x70b0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//中断io和复位io</span></span><br><span class="line">    IOMUXC_SetPinMux(IOMUXC_GPIO1_IO09_GPIO1_IO09, <span class="number">0</span>);</span><br><span class="line">    IOMUXC_SetPinMux(IOMUXC_SNVS_SNVS_TAMPER9_GPIO5_IO09, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    IOMUXC_SetPinConfig(IOMUXC_GPIO1_IO09_GPIO1_IO09, <span class="number">0x7080</span>);</span><br><span class="line">    IOMUXC_SetPinConfig(IOMUXC_SNVS_SNVS_TAMPER9_GPIO5_IO09, <span class="number">0x10b0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化触摸屏中断IO和复位IO */</span></span><br><span class="line">    <span class="type">gpio_pin_config_t</span> ctint_config;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//中断io初始化</span></span><br><span class="line">    ctint_config.direction = kGPIO_DigitalInput;</span><br><span class="line">    ctint_config.interruptMode = kGPIO_IntFallingOrRisingEdge;</span><br><span class="line">    gpio_init(GPIO1, <span class="number">9</span>, &amp;ctint_config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//中断函数使能注册</span></span><br><span class="line">    GIC_EnableIRQ(GPIO1_Combined_0_15_IRQn);</span><br><span class="line">    system_register_irqhandler(GPIO1_Combined_0_15_IRQn, (<span class="type">system_irq_handler_t</span>)gpio1_io09_irqhandler, <span class="literal">NULL</span>);</span><br><span class="line">    gpio_enableint(GPIO1, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.I2C初始化</span></span><br><span class="line">    i2c_init(I2C2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.ft5426初始化</span></span><br><span class="line">    gpio_pinwrite(GPIO5, <span class="number">9</span>, <span class="number">0</span>); <span class="comment">//复位</span></span><br><span class="line">    delay_ms(<span class="number">20</span>);</span><br><span class="line">    gpio_pinwrite(GPIO5, <span class="number">9</span>, <span class="number">1</span>); <span class="comment">//停止复位</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化完成</span></span><br><span class="line">    ft5426_dev.initfalg = FT5426_INIT_FINISHED;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//触摸屏中断处理函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio1_io09_irqhandler</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ft5426_dev.initfalg == FT5426_INIT_FINISHED)</span><br><span class="line">    &#123;</span><br><span class="line">        ft5426_read_tpcoord();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    gpio_clearintflags(GPIO1, <span class="number">9</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 向FT5429写入数据</span></span><br><span class="line"><span class="comment"> * @param - addr: 设备地址</span></span><br><span class="line"><span class="comment"> * @param - reg : 要写入的寄存器</span></span><br><span class="line"><span class="comment"> * @param - data: 要写入的数据</span></span><br><span class="line"><span class="comment"> * @return 		: 操作结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ft5426_write_byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> reg, <span class="type">unsigned</span> <span class="type">char</span> data)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> status=<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> writedata = data;</span><br><span class="line">    i2c_transfer masterXfer;</span><br><span class="line"></span><br><span class="line">    masterXfer.slaveAddress = addr;</span><br><span class="line">    masterXfer.direction = kI2C_Write;</span><br><span class="line">    masterXfer.subaddress = reg;</span><br><span class="line">    masterXfer.subaddressSize = <span class="number">1</span>;</span><br><span class="line">    masterXfer.data = &amp;writedata;</span><br><span class="line">    masterXfer.dataSize = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i2c_master_transfer(I2C2, &amp;masterXfer))</span><br><span class="line">    &#123;</span><br><span class="line">        status = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 从FT5426读取一个字节的数据</span></span><br><span class="line"><span class="comment"> * @param - addr: 设备地址</span></span><br><span class="line"><span class="comment"> * @param - reg : 要读取的寄存器</span></span><br><span class="line"><span class="comment"> * @return 		: 读取到的数据。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ft5426_read_byte</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> reg)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> value;</span><br><span class="line">    i2c_transfer masterXfer;</span><br><span class="line"></span><br><span class="line">    masterXfer.slaveAddress = addr;</span><br><span class="line">    masterXfer.direction = kI2C_Read;</span><br><span class="line">    masterXfer.subaddress = reg;</span><br><span class="line">    masterXfer.subaddressSize = <span class="number">1</span>;</span><br><span class="line">    masterXfer.data = &amp;value;</span><br><span class="line">    masterXfer.dataSize = <span class="number">1</span>;</span><br><span class="line">    i2c_master_transfer(I2C2, &amp;masterXfer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 从FT5429读取多个字节的数据</span></span><br><span class="line"><span class="comment"> * @param - addr: 设备地址</span></span><br><span class="line"><span class="comment"> * @param - reg : 要读取的开始寄存器地址</span></span><br><span class="line"><span class="comment"> * @param - len : 要读取的数据长度.</span></span><br><span class="line"><span class="comment"> * @param - buf : 读取到的数据缓冲区</span></span><br><span class="line"><span class="comment"> * @return 		: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ft5426_read_len</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> addr, <span class="type">unsigned</span> <span class="type">char</span> reg, <span class="type">unsigned</span> <span class="type">char</span> len, <span class="type">unsigned</span> <span class="type">char</span> *buf)</span>&#123;</span><br><span class="line">    i2c_transfer masterXfer;</span><br><span class="line"></span><br><span class="line">    masterXfer.slaveAddress = addr;</span><br><span class="line">    masterXfer.direction = kI2C_Read;</span><br><span class="line">    masterXfer.subaddress = reg;</span><br><span class="line">    masterXfer.subaddressSize = <span class="number">1</span>;</span><br><span class="line">    masterXfer.data = buf;</span><br><span class="line">    masterXfer.dataSize = len;</span><br><span class="line">    i2c_master_transfer(I2C2, &amp;masterXfer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 读取当前触摸点个数</span></span><br><span class="line"><span class="comment"> * @param 		: 无</span></span><br><span class="line"><span class="comment"> * @return 		: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ft5426_read_tpnum</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	ft5426_dev.point_num = ft5426_read_byte(FT5426_ADDR, FT5426_TD_STATUS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 读取当前所有触摸点的坐标</span></span><br><span class="line"><span class="comment"> * @param 		: 无</span></span><br><span class="line"><span class="comment"> * @return 		: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ft5426_read_tpcoord</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> type = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> pointbuf[FT5426_XYCOORDREG_NUM];</span><br><span class="line"></span><br><span class="line">    ft5426_dev.point_num = ft5426_read_byte(FT5426_ADDR, FT5426_TD_STATUS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	 * 从寄存器FT5426_TOUCH1_XH开始，连续读取30个寄存器的值，这30个寄存器</span></span><br><span class="line"><span class="comment">  	 * 保存着5个点的触摸值，每个点占用6个寄存器。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    ft5426_read_len(FT5426_ADDR, FT5426_TOUCH1_XH, FT5426_XYCOORDREG_NUM, pointbuf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ft5426_dev.point_num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> *buf = &amp;pointbuf[i*<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 以第一个触摸点为例，寄存器TOUCH1_XH(地址0X03),各位描述如下：</span></span><br><span class="line"><span class="comment">		 * bit7:6  Event flag  0:按下 1:释放 2：接触 3：没有事件</span></span><br><span class="line"><span class="comment">		 * bit5:4  保留</span></span><br><span class="line"><span class="comment">		 * bit3:0  X轴触摸点的11~8位。</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">        ft5426_dev.x[i] = ((buf[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | (buf[<span class="number">3</span>] &lt;&lt; <span class="number">0</span>)) &amp; <span class="number">0x0fff</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 以第一个触摸点为例，寄存器TOUCH1_YH(地址0X05),各位描述如下：</span></span><br><span class="line"><span class="comment">		 * bit7:4  Touch ID  触摸ID，表示是哪个触摸点</span></span><br><span class="line"><span class="comment">		 * bit3:0  Y轴触摸点的11~8位。</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">        ft5426_dev.y[i] = ((buf[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) | (buf[<span class="number">1</span>] &lt;&lt; <span class="number">0</span>)) &amp; <span class="number">0x0fff</span>;</span><br><span class="line"></span><br><span class="line">        type = buf[<span class="number">0</span>] &lt;&lt; <span class="number">6</span>; <span class="comment">//获取类型</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(type == FT5426_TOUCH_EVENT_DOWN || type == FT5426_TOUCH_EVENT_ON )<span class="comment">/* 按下 	*/</span></span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">		&#125; <span class="keyword">else</span>  &#123;	<span class="comment">/* 释放 */</span>	</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="19-PWM背光调试"><a href="#19-PWM背光调试" class="headerlink" title="19. PWM背光调试"></a>19. PWM背光调试</h2><h3 id="19-1-基本流程"><a href="#19-1-基本流程" class="headerlink" title="19.1. 基本流程"></a>19.1. 基本流程</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1-》配置引脚 GPIO1_IO8</span><br><span class="line">	配置 GPIO1_IO08 的复用功能，将其复用为 PWM1_OUT 信号线</span><br><span class="line">2-》初始化 PWM1</span><br><span class="line">	初始化 PWM1，配置所需的 PWM 信号的频率和默认占空比</span><br><span class="line">3-》设置中断</span><br><span class="line">	因为 FIFO 中的采样值每个周期都会少一个，所以需要不断的向 FIFO 中写入采样值，防止其为空。当 FIFO 为空的时候触发相应的中断，然后在中断处理函数中向 FIFO 写入采样值</span><br><span class="line">4-》使能 PWM1</span><br></pre></td></tr></table></figure>

<h3 id="19-2-代码编写"><a href="#19-2-代码编写" class="headerlink" title="19.2. 代码编写"></a>19.2. 代码编写</h3><h4 id="bsp-backlight-h"><a href="#bsp-backlight-h" class="headerlink" title="bsp_backlight.h"></a>bsp_backlight.h</h4><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BSP_BACKLIGHT_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BSP_BACKLIGHT_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 背光PWM结构体 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">backlight_dev_struc</span></span></span><br><span class="line"><span class="class">&#123;</span>	</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> pwm_duty;		<span class="comment">/* 占空比	*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">backlight_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_enable</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_irqhandler</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_setperiod_value</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_setsample_value</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_setduty</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !__BSP_BACKLIGHT_H</span></span></span><br></pre></td></tr></table></figure>

<h4 id="bsp-backlight-c"><a href="#bsp-backlight-c" class="headerlink" title="bsp_backlight.c"></a>bsp_backlight.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_backlight.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_int.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 背光设备 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">backlight_dev_struc</span> <span class="title">backlight_dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 初始化背光PWM</span></span><br><span class="line"><span class="comment"> * @param		: 无</span></span><br><span class="line"><span class="comment"> * @return 		: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">backlight_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1、背光PWM IO初始化 */</span></span><br><span class="line">    IOMUXC_SetPinMux(IOMUXC_GPIO1_IO08_PWM1_OUT, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 配置PWM IO属性	</span></span><br><span class="line"><span class="comment">	 *bit 16:0 HYS关闭</span></span><br><span class="line"><span class="comment">	 *bit [15:14]: 10 100K上拉</span></span><br><span class="line"><span class="comment">	 *bit [13]: 1 pull功能</span></span><br><span class="line"><span class="comment">	 *bit [12]: 1 pull/keeper使能</span></span><br><span class="line"><span class="comment">	 *bit [11]: 0 关闭开路输出</span></span><br><span class="line"><span class="comment">	 *bit [7:6]: 10 速度100Mhz</span></span><br><span class="line"><span class="comment">	 *bit [5:3]: 010 驱动能力为R0/2</span></span><br><span class="line"><span class="comment">	 *bit [0]: 0 低转换率</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    IOMUXC_SetPinConfig(IOMUXC_GPIO1_IO08_PWM1_OUT, <span class="number">0xb090</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2、初始化PWM1		*/</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">   	 * 初始化寄存器PWMCR</span></span><br><span class="line"><span class="comment">   	 * bit[27:26]	: 01  当FIFO中空余位置大于等于2的时候FIFO空标志值位</span></span><br><span class="line"><span class="comment">   	 * bit[25]		: 0   停止模式下PWM不工作</span></span><br><span class="line"><span class="comment">   	 * bit[24]		: 0	  休眠模式下PWM不工作</span></span><br><span class="line"><span class="comment">   	 * bit[23]		: 0   等待模式下PWM不工作</span></span><br><span class="line"><span class="comment">   	 * bit[22]		: 0   调试模式下PWM不工作</span></span><br><span class="line"><span class="comment">   	 * bit[21]		: 0   关闭字节交换</span></span><br><span class="line"><span class="comment">   	 * bit[20]		: 0	  关闭半字数据交换</span></span><br><span class="line"><span class="comment">   	 * bit[19:18]	: 00  PWM输出引脚在计数器重新计数的时候输出高电平</span></span><br><span class="line"><span class="comment">   	 *					  在计数器计数值达到比较值以后输出低电平</span></span><br><span class="line"><span class="comment">   	 * bit[17:16]	: 01  PWM时钟源选择IPG CLK = 66MHz</span></span><br><span class="line"><span class="comment">   	 * bit[15:4]	: 65  分频系数为65+1=66，PWM时钟源 = 66MHZ/66=1MHz</span></span><br><span class="line"><span class="comment">   	 * bit[3]		: 0	  PWM不复位</span></span><br><span class="line"><span class="comment">   	 * bit[2:1]		: 00  FIFO中的sample数据每个只能使用一次。</span></span><br><span class="line"><span class="comment">   	 * bit[0]		: 0   先关闭PWM，后面再使能</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    PWM1-&gt;PWMCR = <span class="number">0</span>;</span><br><span class="line">    PWM1-&gt;PWMCR = (<span class="number">0x1</span>&lt;&lt;<span class="number">26</span>) | (<span class="number">0x1</span>&lt;&lt;<span class="number">16</span>) | (<span class="number">0x65</span>&lt;&lt;<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置PWM周期为1000,那么PWM频率就是1M/1000 = 1KHz。 */</span></span><br><span class="line">    pwm1_setperiod_value(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置占空比，默认50%占空比   ,写四次是因为有4个FIFO */</span></span><br><span class="line">    backlight_dev.pwm_duty = <span class="number">50</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		pwm1_setduty(backlight_dev.pwm_duty);	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 使能FIFO空中断，设置寄存器PWMIR寄存器的bit0为1 */</span></span><br><span class="line">    PWM1-&gt;PWMIR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);    <span class="comment">//使能空闲中断</span></span><br><span class="line">    GIC_EnableIRQ(PWM1_IRQn);   <span class="comment">//使能中断</span></span><br><span class="line">    system_register_irqhandler(PWM1_IRQn, (<span class="type">system_irq_handler_t</span>)pwm1_irqhandler, <span class="literal">NULL</span>); <span class="comment">//注册中断函数</span></span><br><span class="line">    PWM1-&gt;PWMSR = <span class="number">0</span>;        <span class="comment">//中断状态寄存器清零</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使能PWM</span></span><br><span class="line">    pwm1_enable();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 使能PWM</span></span><br><span class="line"><span class="comment"> * @param		: 无</span></span><br><span class="line"><span class="comment"> * @return 		: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_enable</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    PWM1-&gt;PWMCR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: pwm1中断处理函数</span></span><br><span class="line"><span class="comment"> * @param		: 无</span></span><br><span class="line"><span class="comment"> * @return 		: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_irqhandler</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">/* FIFO为空中断 */</span></span><br><span class="line">    <span class="keyword">if</span> ((PWM1-&gt;PWMSR &amp; (<span class="number">0x1</span>&lt;&lt;<span class="number">3</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 将占空比信息写入到FIFO中,其实就是设置占空比 */</span></span><br><span class="line">        pwm1_setduty(backlight_dev.pwm_duty);</span><br><span class="line">        PWM1-&gt;PWMSR |= (<span class="number">0x1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: 设置PWM周期，就是设置寄存器PWMPR，PWM周期公式如下</span></span><br><span class="line"><span class="comment"> *					  PWM_FRE = PWM_CLK / (PERIOD + 2)， 比如当前PWM_CLK=1MHz</span></span><br><span class="line"><span class="comment"> *					  要产生1KHz的PWM，那么PERIOD = 1000000/1K - 2 = 	998</span></span><br><span class="line"><span class="comment"> * @param -  value	: 周期值，范围0~0XFFFF</span></span><br><span class="line"><span class="comment"> * @return 			: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_setperiod_value</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> regvalue=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        regvalue = <span class="number">2</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        regvalue = value - <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PWM1-&gt;PWMPR |= (regvalue &lt;&lt; <span class="number">0</span>) &amp; <span class="number">0xffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: 设置Sample寄存器，Sample数据会写入到FIFO中，</span></span><br><span class="line"><span class="comment"> * 					  所谓的Sample寄存器，就相当于比较寄存器，假如PWMCR中的POUTC</span></span><br><span class="line"><span class="comment"> *				  	  设置为00的时候。当PWM计数器中的计数值小于Sample的时候</span></span><br><span class="line"><span class="comment"> *					  就会输出高电平，当PWM计数器值大于Sample的时候输出底电平,</span></span><br><span class="line"><span class="comment"> *					  因此可以通过设置Sample寄存器来设置占空比</span></span><br><span class="line"><span class="comment"> * @param -  value	: 寄存器值，范围0~0XFFFF</span></span><br><span class="line"><span class="comment"> * @return 			: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_setsample_value</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value)</span>&#123;</span><br><span class="line">    PWM1-&gt;PWMSAR |= (value &lt;&lt; <span class="number">0</span>) &amp; <span class="number">0xffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: 设置PWM占空比</span></span><br><span class="line"><span class="comment"> * @param -  value	: 占空比0~100，对应0%~100%</span></span><br><span class="line"><span class="comment"> * @return 			: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm1_setduty</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> value)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> period=<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> sample=<span class="number">0</span>;</span><br><span class="line">    backlight_dev.pwm_duty = value;</span><br><span class="line">    period = PWM1-&gt;PWMPR + <span class="number">2</span>;</span><br><span class="line">    sample = (<span class="type">unsigned</span> <span class="type">short</span>)period * backlight_dev.pwm_duty / <span class="number">100.0f</span>;</span><br><span class="line">    pwm1_setsample_value(sample);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/12/20/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/linux/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD3/" rel="prev" title="嵌入式linux入门(三)：linux-ARM裸机四">
                  <i class="fa fa-chevron-left"></i> 嵌入式linux入门(三)：linux-ARM裸机四
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/12/26/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/linux/linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%911/" rel="next" title="嵌入式linux入门(四)：linux-ARM驱动(1)">
                  嵌入式linux入门(四)：linux-ARM驱动(1) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  




  




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"http://example.com/2023/12/25/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%90/linux/I.MX6ULL%E8%A3%B8%E6%9C%BA%E5%BC%80%E5%8F%91%E7%BB%AD4/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
