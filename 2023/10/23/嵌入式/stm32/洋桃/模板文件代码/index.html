<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="stm32的各种类型的驱动代码模板">
<meta property="og:type" content="article">
<meta property="og:title" content="stm32驱动代码合集">
<meta property="og:url" content="http://example.com/2023/10/23/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%B4%8B%E6%A1%83/%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E4%BB%A3%E7%A0%81/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="stm32的各种类型的驱动代码模板">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-10-23T06:31:07.252Z">
<meta property="article:modified_time" content="2023-10-30T10:16:10.979Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2023/10/23/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%B4%8B%E6%A1%83/%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E4%BB%A3%E7%A0%81/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2023/10/23/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%B4%8B%E6%A1%83/%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E4%BB%A3%E7%A0%81/","path":"2023/10/23/嵌入式/stm32/洋桃/模板文件代码/","title":"stm32驱动代码合集"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>stm32驱动代码合集 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#main-c"><span class="nav-number">1.</span> <span class="nav-text">main.c</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Basic"><span class="nav-number">2.</span> <span class="nav-text">Basic</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-sys"><span class="nav-number">2.1.</span> <span class="nav-text">1. sys</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-h"><span class="nav-number">2.1.1.</span> <span class="nav-text">sys.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-c"><span class="nav-number">2.1.2.</span> <span class="nav-text">sys.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-delay"><span class="nav-number">2.2.</span> <span class="nav-text">2. delay</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#delay-h"><span class="nav-number">2.2.1.</span> <span class="nav-text">delay.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delay-c"><span class="nav-number">2.2.2.</span> <span class="nav-text">delay.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-rtc"><span class="nav-number">2.3.</span> <span class="nav-text">3. rtc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#rtc-h"><span class="nav-number">2.3.1.</span> <span class="nav-text">rtc.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rtc-c"><span class="nav-number">2.3.2.</span> <span class="nav-text">rtc.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-i2c"><span class="nav-number">2.4.</span> <span class="nav-text">4. i2c</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-h"><span class="nav-number">2.4.1.</span> <span class="nav-text">i2c.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i2c-c"><span class="nav-number">2.4.2.</span> <span class="nav-text">i2c.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-flash"><span class="nav-number">2.5.</span> <span class="nav-text">5. flash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#flash-h"><span class="nav-number">2.5.1.</span> <span class="nav-text">flash.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flash-c"><span class="nav-number">2.5.2.</span> <span class="nav-text">flash.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hardware"><span class="nav-number">3.</span> <span class="nav-text">Hardware</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-TM1640"><span class="nav-number">3.1.</span> <span class="nav-text">1. TM1640</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TM1640-h"><span class="nav-number">3.1.1.</span> <span class="nav-text">TM1640.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TM1640-c"><span class="nav-number">3.1.2.</span> <span class="nav-text">TM1640.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-LM75A"><span class="nav-number">3.2.</span> <span class="nav-text">2. LM75A</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lm75a-h"><span class="nav-number">3.2.1.</span> <span class="nav-text">lm75a.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lm75a-c"><span class="nav-number">3.2.2.</span> <span class="nav-text">lm75a.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%A7%A6%E6%91%B8%E6%8C%89%E9%94%AE"><span class="nav-number">3.3.</span> <span class="nav-text">3. 触摸按键</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#touch-key-h"><span class="nav-number">3.3.1.</span> <span class="nav-text">touch_key.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#touch-key-c"><span class="nav-number">3.3.2.</span> <span class="nav-text">touch_key.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-BUZZER"><span class="nav-number">3.4.</span> <span class="nav-text">4. BUZZER</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#buzzer-h"><span class="nav-number">3.4.1.</span> <span class="nav-text">buzzer.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#buzzer-c"><span class="nav-number">3.4.2.</span> <span class="nav-text">buzzer.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-RELAY"><span class="nav-number">3.5.</span> <span class="nav-text">5. RELAY</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#relay-h"><span class="nav-number">3.5.1.</span> <span class="nav-text">relay.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#relay-c"><span class="nav-number">3.5.2.</span> <span class="nav-text">relay.c</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/23/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%B4%8B%E6%A1%83/%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="stm32驱动代码合集 | Hexo">
      <meta itemprop="description" content="stm32的各种类型的驱动代码模板">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          stm32驱动代码合集
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-23 14:31:07" itemprop="dateCreated datePublished" datetime="2023-10-23T14:31:07+08:00">2023-10-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-30 18:16:10" itemprop="dateModified" datetime="2023-10-30T18:16:10+08:00">2023-10-30</time>
    </span>

  
</div>

            <div class="post-description">stm32的各种类型的驱动代码模板</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span> <span class="comment">//STM32头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rtc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TM1640.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lm75a.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;touch_key.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span>&#123;<span class="comment">//主程序</span></span><br><span class="line">    <span class="comment">// 变量定义</span></span><br><span class="line">	</span><br><span class="line">	delay_ms(<span class="number">200</span>);	<span class="comment">//等待单片机功能启动</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 系统初始化</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">// 主体</span></span><br><span class="line">		<span class="keyword">if</span>(rtc_up)&#123;</span><br><span class="line">			rtc_up=<span class="number">0</span>;</span><br><span class="line">			RTC_Set(ryear, rmon, rday, rhour, rmin, rsec);<span class="comment">//将修改后的时间值写回RTC</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(MENU&lt;<span class="number">2</span> || MENU&gt;<span class="number">8</span>)&#123;</span><br><span class="line">			RTC_Get();	<span class="comment">//读取RTC时间</span></span><br><span class="line">			LM75A_GetTemp(buffer); <span class="comment">//读取LM75A的温度数据</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		wait_times++;</span><br><span class="line">		<span class="keyword">if</span>(MENU &lt; <span class="number">3</span>)&#123;	<span class="comment">//不同于调时菜单</span></span><br><span class="line">			<span class="keyword">if</span>(wait_times==<span class="number">1</span>)	MENU=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(wait_times==<span class="number">7000</span>)	MENU=<span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span>(wait_times==<span class="number">10000</span>)	MENU=<span class="number">2</span>;</span><br><span class="line">			<span class="keyword">if</span>(wait_times==<span class="number">13000</span>)	MENU=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//日期显示</span></span><br><span class="line">        <span class="comment">//时间显示</span></span><br><span class="line">        <span class="comment">//温度显示</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//进入SEt页面，不做控制，延时后直接进入设置模式</span></span><br><span class="line">		<span class="keyword">if</span>(MENU==<span class="number">3</span>)&#123;</span><br><span class="line">			TM1640_display(<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">			TM1640_display(<span class="number">1</span>,<span class="number">20</span>);</span><br><span class="line">			TM1640_display(<span class="number">2</span>,<span class="number">20</span>);	<span class="comment">//无</span></span><br><span class="line">			TM1640_display(<span class="number">3</span>,<span class="number">23</span>);	<span class="comment">//S</span></span><br><span class="line">			TM1640_display(<span class="number">4</span>,<span class="number">24</span>);	<span class="comment">//E</span></span><br><span class="line">			TM1640_display(<span class="number">5</span>,<span class="number">25</span>);	<span class="comment">//t</span></span><br><span class="line">			TM1640_display(<span class="number">6</span>,<span class="number">20</span>);</span><br><span class="line">			TM1640_display(<span class="number">7</span>,<span class="number">20</span>);</span><br><span class="line">			</span><br><span class="line">			delay_ms(<span class="number">2000</span>);		<span class="comment">//延时2秒</span></span><br><span class="line">			MENU = <span class="number">4</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//日期修改-年月日</span></span><br><span class="line">        <span class="comment">//时间修改-时分</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h1><h2 id="1-sys"><a href="#1-sys" class="headerlink" title="1. sys"></a>1. sys</h2><h3 id="sys-h"><a href="#sys-h" class="headerlink" title="sys.h"></a>sys.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __SYS_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SYS_H	</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span>	 </span></span><br><span class="line">																	    </span><br><span class="line">	 </span><br><span class="line"><span class="comment">//位带操作,实现51类似的GPIO控制功能</span></span><br><span class="line"><span class="comment">//具体实现思想,参考&lt;&lt;CM3权威指南&gt;&gt;第五章(87页~92页).</span></span><br><span class="line"><span class="comment">//IO口操作宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BITBAND(addr, bitnum) ((addr &amp; 0xF0000000)+0x2000000+((addr &amp;0xFFFFF)&lt;&lt;5)+(bitnum&lt;&lt;2)) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEM_ADDR(addr)  *((volatile unsigned long  *)(addr)) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIT_ADDR(addr, bitnum)   MEM_ADDR(BITBAND(addr, bitnum)) </span></span><br><span class="line"><span class="comment">//IO口地址映射</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOA_ODR_Addr    (GPIOA_BASE+12) <span class="comment">//0x4001080C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOB_ODR_Addr    (GPIOB_BASE+12) <span class="comment">//0x40010C0C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOC_ODR_Addr    (GPIOC_BASE+12) <span class="comment">//0x4001100C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOD_ODR_Addr    (GPIOD_BASE+12) <span class="comment">//0x4001140C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOE_ODR_Addr    (GPIOE_BASE+12) <span class="comment">//0x4001180C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOF_ODR_Addr    (GPIOF_BASE+12) <span class="comment">//0x40011A0C    </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOG_ODR_Addr    (GPIOG_BASE+12) <span class="comment">//0x40011E0C    </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOA_IDR_Addr    (GPIOA_BASE+8) <span class="comment">//0x40010808 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOB_IDR_Addr    (GPIOB_BASE+8) <span class="comment">//0x40010C08 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOC_IDR_Addr    (GPIOC_BASE+8) <span class="comment">//0x40011008 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOD_IDR_Addr    (GPIOD_BASE+8) <span class="comment">//0x40011408 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOE_IDR_Addr    (GPIOE_BASE+8) <span class="comment">//0x40011808 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOF_IDR_Addr    (GPIOF_BASE+8) <span class="comment">//0x40011A08 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOG_IDR_Addr    (GPIOG_BASE+8) <span class="comment">//0x40011E08 </span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//IO口操作,只对单一的IO口!</span></span><br><span class="line"><span class="comment">//确保n的值小于16!</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAout(n)   BIT_ADDR(GPIOA_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAin(n)    BIT_ADDR(GPIOA_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PBout(n)   BIT_ADDR(GPIOB_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PBin(n)    BIT_ADDR(GPIOB_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCout(n)   BIT_ADDR(GPIOC_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCin(n)    BIT_ADDR(GPIOC_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDout(n)   BIT_ADDR(GPIOD_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDin(n)    BIT_ADDR(GPIOD_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEout(n)   BIT_ADDR(GPIOE_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEin(n)    BIT_ADDR(GPIOE_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFout(n)   BIT_ADDR(GPIOF_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFin(n)    BIT_ADDR(GPIOF_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGout(n)   BIT_ADDR(GPIOG_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGin(n)    BIT_ADDR(GPIOG_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">NVIC_Configuration</span><span class="params">(<span class="type">void</span>)</span>; <span class="comment">//嵌套中断控制器的设置</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RCC_Configuration</span><span class="params">(<span class="type">void</span>)</span>; <span class="comment">//RCC时钟类的设置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="sys-c"><a href="#sys-c" class="headerlink" title="sys.c"></a>sys.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">NVIC_Configuration</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//嵌套中断向量控制器 的设置</span></span><br><span class="line">    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);	<span class="comment">//设置NVIC中断分组2:2位抢占优先级，2位响应优先级</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RCC_Configuration</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//RCC时钟的设置  </span></span><br><span class="line">	ErrorStatus HSEStartUpStatus;   </span><br><span class="line">	RCC_DeInit();              <span class="comment">/* RCC system reset(for debug purpose) RCC寄存器恢复初始化值*/</span>   </span><br><span class="line">	RCC_HSEConfig(RCC_HSE_ON); <span class="comment">/* Enable HSE 使能外部高速晶振*/</span>   </span><br><span class="line">	HSEStartUpStatus = RCC_WaitForHSEStartUp(); <span class="comment">/* Wait till HSE is ready 等待外部高速晶振使能完成*/</span>   </span><br><span class="line">	<span class="keyword">if</span>(HSEStartUpStatus == SUCCESS)&#123;   </span><br><span class="line">		<span class="comment">/*设置PLL时钟源及倍频系数*/</span>   </span><br><span class="line">		RCC_PLLConfig(RCC_PLLSource_HSE_Div1, RCC_PLLMul_9); <span class="comment">//RCC_PLLMul_x（枚举2~16）是倍频值。当HSE=8MHZ,RCC_PLLMul_9时PLLCLK=72MHZ   </span></span><br><span class="line">		<span class="comment">/*设置AHB时钟（HCLK）*/</span>   </span><br><span class="line">		RCC_HCLKConfig(RCC_SYSCLK_Div1); <span class="comment">//RCC_SYSCLK_Div1——AHB时钟 = 系统时钟(SYSCLK) = 72MHZ（外部晶振8HMZ）   </span></span><br><span class="line">		<span class="comment">/*注意此处的设置，如果使用SYSTICK做延时程序，此时SYSTICK(Cortex System timer)=HCLK/8=9MHZ*/</span>   </span><br><span class="line">		RCC_PCLK1Config(RCC_HCLK_Div2); <span class="comment">//设置低速AHB时钟（PCLK1）,RCC_HCLK_Div2——APB1时钟 = HCLK/2 = 36MHZ（外部晶振8HMZ）   </span></span><br><span class="line">		RCC_PCLK2Config(RCC_HCLK_Div1); <span class="comment">//设置高速AHB时钟（PCLK2）,RCC_HCLK_Div1——APB2时钟 = HCLK = 72MHZ（外部晶振8HMZ）   </span></span><br><span class="line">		<span class="comment">/*注：AHB主要负责外部存储器时钟。APB2负责AD，I/O，高级TIM，串口1。APB1负责DA，USB，SPI，I2C，CAN，串口2，3，4，5，普通TIM */</span>  </span><br><span class="line">		FLASH_SetLatency(FLASH_Latency_2); <span class="comment">//设置FLASH存储器延时时钟周期数   </span></span><br><span class="line">		<span class="comment">/*FLASH时序延迟几个周期，等待总线同步操作。   </span></span><br><span class="line"><span class="comment">		推荐按照单片机系统运行频率：</span></span><br><span class="line"><span class="comment">		0—24MHz时，取Latency_0；   </span></span><br><span class="line"><span class="comment">		24—48MHz时，取Latency_1；   </span></span><br><span class="line"><span class="comment">		48~72MHz时，取Latency_2*/</span>   </span><br><span class="line">		FLASH_PrefetchBufferCmd(FLASH_PrefetchBuffer_Enable); <span class="comment">//选择FLASH预取指缓存的模式，预取指缓存使能   </span></span><br><span class="line">		RCC_PLLCmd(ENABLE);	<span class="comment">//使能PLL</span></span><br><span class="line">		<span class="keyword">while</span>(RCC_GetFlagStatus(RCC_FLAG_PLLRDY) == RESET); <span class="comment">//等待PLL输出稳定   </span></span><br><span class="line">		RCC_SYSCLKConfig(RCC_SYSCLKSource_PLLCLK); <span class="comment">//选择SYSCLK时钟源为PLL</span></span><br><span class="line">		<span class="keyword">while</span>(RCC_GetSYSCLKSource() != <span class="number">0x08</span>); <span class="comment">//等待PLL成为SYSCLK时钟源   </span></span><br><span class="line">	&#125;  </span><br><span class="line">	<span class="comment">/*开始使能程序中需要使用的外设时钟*/</span>   </span><br><span class="line"><span class="comment">//	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1 | RCC_APB2Periph_GPIOA | RCC_APB2Periph_GPIOB |   </span></span><br><span class="line"><span class="comment">//	RCC_APB2Periph_GPIOC | RCC_APB2Periph_GPIOD | RCC_APB2Periph_GPIOE, ENABLE); //APB2外设时钟使能      </span></span><br><span class="line"><span class="comment">//	RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART2, ENABLE); //APB1外设时钟使能  </span></span><br><span class="line"><span class="comment">//	RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART3, ENABLE);   </span></span><br><span class="line"><span class="comment">//	RCC_APB2PeriphClockCmd(RCC_APB2Periph_SPI1, ENABLE);   	 </span></span><br><span class="line"><span class="comment">//	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);    </span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-delay"><a href="#2-delay" class="headerlink" title="2. delay"></a>2. delay</h2><h3 id="delay-h"><a href="#delay-h" class="headerlink" title="delay.h"></a>delay.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __DELAY_H 			   </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_s</span><span class="params">(u16 s)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(u16 ms)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(u32 us)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="delay-c"><a href="#delay-c" class="headerlink" title="delay.c"></a>delay.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AHB_INPUT  72  <span class="comment">//请按RCC中设置的AHB时钟频率填写到这里（单位MHz）</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(u32 uS)</span>&#123; <span class="comment">//uS微秒级延时程序（参考值即是延时数，72MHz时最大值233015）	</span></span><br><span class="line">	SysTick-&gt;LOAD=AHB_INPUT*uS;      <span class="comment">//重装计数初值（当主频是72MHz，72次为1微秒）</span></span><br><span class="line">	SysTick-&gt;VAL=<span class="number">0x00</span>;        <span class="comment">//清空定时器的计数器</span></span><br><span class="line">	SysTick-&gt;CTRL=<span class="number">0x00000005</span>;<span class="comment">//时钟源HCLK，打开定时器</span></span><br><span class="line">	<span class="keyword">while</span>(!(SysTick-&gt;CTRL&amp;<span class="number">0x00010000</span>)); <span class="comment">//等待计数到0</span></span><br><span class="line">	SysTick-&gt;CTRL=<span class="number">0x00000004</span>;<span class="comment">//关闭定时器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(u16 ms)</span>&#123; <span class="comment">//mS毫秒级延时程序（参考值即是延时数，最大值65535）	 		  	  </span></span><br><span class="line">	<span class="keyword">while</span>( ms-- != <span class="number">0</span>)&#123;</span><br><span class="line">		delay_us(<span class="number">1000</span>);	<span class="comment">//调用1000微秒的延时</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_s</span><span class="params">(u16 s)</span>&#123; <span class="comment">//S秒级延时程序（参考值即是延时数，最大值65535）	 		  	  </span></span><br><span class="line">	<span class="keyword">while</span>( s-- != <span class="number">0</span>)&#123;</span><br><span class="line">		delay_ms(<span class="number">1000</span>);	<span class="comment">//调用1000毫秒的延时</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="3-rtc"><a href="#3-rtc" class="headerlink" title="3. rtc"></a>3. rtc</h2><h3 id="rtc-h"><a href="#rtc-h" class="headerlink" title="rtc.h"></a>rtc.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __RTC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __RTC_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span> </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//全局变量的声明，在rtc.c文件中定义</span></span><br><span class="line"><span class="comment">//以下2条是使用extern语句声明全局变量</span></span><br><span class="line"><span class="comment">//注意：这里不能给变量赋值</span></span><br><span class="line"><span class="keyword">extern</span> u16 ryear;</span><br><span class="line"><span class="keyword">extern</span> u8 rmon,rday,rhour,rmin,rsec,rweek;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RTC_First_Config</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//首次启用RTC的设置</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RTC_Config</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//实时时钟初始化</span></span><br><span class="line">u8 <span class="title function_">Is_Leap_Year</span><span class="params">(u16 year)</span>;<span class="comment">//判断是否是闰年函数                    </span></span><br><span class="line">u8 <span class="title function_">RTC_Get</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//读出当前时间值	</span></span><br><span class="line">u8 <span class="title function_">RTC_Set</span><span class="params">(u16 syear,u8 smon,u8 sday,u8 hour,u8 min,u8 sec)</span>;<span class="comment">//写入当前时间</span></span><br><span class="line">u8 <span class="title function_">RTC_Get_Week</span><span class="params">(u16 year,u8 month,u8 day)</span>;<span class="comment">//按年月日计算星期</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="rtc-c"><a href="#rtc-c" class="headerlink" title="rtc.c"></a>rtc.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rtc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下2条全局变量--用于RTC时间的读取</span></span><br><span class="line">u16 ryear; <span class="comment">//4位年</span></span><br><span class="line">u8 rmon,rday,rhour,rmin,rsec,rweek;<span class="comment">//2位月日时分秒周</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RTC_First_Config</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//首次启用RTC的设置</span></span><br><span class="line">    RCC_APB1PeriphClockCmd(RCC_APB1Periph_PWR | RCC_APB1Periph_BKP, ENABLE);<span class="comment">//启用PWR和BKP的时钟（from APB1）</span></span><br><span class="line">    PWR_BackupAccessCmd(ENABLE);<span class="comment">//后备域解锁</span></span><br><span class="line">    BKP_DeInit();<span class="comment">//备份寄存器模块复位</span></span><br><span class="line">    RCC_LSEConfig(RCC_LSE_ON);<span class="comment">//外部32.768KHZ晶振开启   </span></span><br><span class="line">    <span class="keyword">while</span> (RCC_GetFlagStatus(RCC_FLAG_LSERDY) == RESET);<span class="comment">//等待稳定    </span></span><br><span class="line">    RCC_RTCCLKConfig(RCC_RTCCLKSource_LSE);<span class="comment">//RTC时钟源配置成LSE（外部低速晶振32.768KHZ）    </span></span><br><span class="line">    RCC_RTCCLKCmd(ENABLE);<span class="comment">//RTC开启    </span></span><br><span class="line">    RTC_WaitForSynchro();<span class="comment">//开启后需要等待APB1时钟与RTC时钟同步，才能读写寄存器    </span></span><br><span class="line">    RTC_WaitForLastTask();<span class="comment">//读写寄存器前，要确定上一个操作已经结束</span></span><br><span class="line">    RTC_SetPrescaler(<span class="number">32767</span>);<span class="comment">//设置RTC分频器，使RTC时钟为1Hz,RTC period = RTCCLK/RTC_PR = (32.768 KHz)/(32767+1)   </span></span><br><span class="line">    RTC_WaitForLastTask();<span class="comment">//等待寄存器写入完成	</span></span><br><span class="line">    <span class="comment">//当不使用RTC秒中断，可以屏蔽下面2条</span></span><br><span class="line"><span class="comment">//    RTC_ITConfig(RTC_IT_SEC, ENABLE);//使能秒中断   </span></span><br><span class="line"><span class="comment">//    RTC_WaitForLastTask();//等待写入完成</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RTC_Config</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//实时时钟初始化</span></span><br><span class="line">    <span class="comment">//在BKP的后备寄存器1中，存了一个特殊字符0xA5A5</span></span><br><span class="line">    <span class="comment">//第一次上电或后备电源掉电后，该寄存器数据丢失，表明RTC数据丢失，需要重新配置</span></span><br><span class="line">    <span class="keyword">if</span> (BKP_ReadBackupRegister(BKP_DR1) != <span class="number">0xA5A5</span>)&#123;<span class="comment">//判断寄存数据是否丢失       </span></span><br><span class="line">        RTC_First_Config();<span class="comment">//重新配置RTC        </span></span><br><span class="line">        BKP_WriteBackupRegister(BKP_DR1, <span class="number">0xA5A5</span>);<span class="comment">//配置完成后，向后备寄存器中写特殊字符0xA5A5</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="comment">//若后备寄存器没有掉电，则无需重新配置RTC</span></span><br><span class="line">        <span class="comment">//这里我们可以利用RCC_GetFlagStatus()函数查看本次复位类型</span></span><br><span class="line">        <span class="keyword">if</span> (RCC_GetFlagStatus(RCC_FLAG_PORRST) != RESET)&#123;</span><br><span class="line">            <span class="comment">//这是上电复位</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (RCC_GetFlagStatus(RCC_FLAG_PINRST) != RESET)&#123;</span><br><span class="line">            <span class="comment">//这是外部RST管脚复位</span></span><br><span class="line">        &#125;       </span><br><span class="line">        RCC_ClearFlag();<span class="comment">//清除RCC中复位标志</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//虽然RTC模块不需要重新配置，且掉电后依靠后备电池依然运行</span></span><br><span class="line">        <span class="comment">//但是每次上电后，还是要使能RTCCLK</span></span><br><span class="line">        RCC_RTCCLKCmd(ENABLE);<span class="comment">//使能RTCCLK        </span></span><br><span class="line">        RTC_WaitForSynchro();<span class="comment">//等待RTC时钟与APB1时钟同步</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//当不使用RTC秒中断，可以屏蔽下面2条</span></span><br><span class="line"><span class="comment">//        RTC_ITConfig(RTC_IT_SEC, ENABLE);//使能秒中断        </span></span><br><span class="line"><span class="comment">//        RTC_WaitForLastTask();//等待操作完成</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="meta">#<span class="keyword">ifdef</span> RTCClockOutput_Enable   </span></span><br><span class="line">	    RCC_APB1PeriphClockCmd(RCC_APB1Periph_PWR | RCC_APB1Periph_BKP, ENABLE);</span><br><span class="line">	    PWR_BackupAccessCmd(ENABLE);   </span><br><span class="line">	    BKP_TamperPinCmd(DISABLE);   </span><br><span class="line">	    BKP_RTCOutputConfig(BKP_RTCOutputSource_CalibClock);</span><br><span class="line">	<span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RTC_IRQHandler</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//RTC时钟1秒触发中断函数（名称固定不可修改）</span></span><br><span class="line">	<span class="keyword">if</span> (RTC_GetITStatus(RTC_IT_SEC) != RESET)&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	RTC_ClearITPendingBit(RTC_IT_SEC); </span><br><span class="line">	RTC_WaitForLastTask();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RTCAlarm_IRQHandler</span><span class="params">(<span class="type">void</span>)</span>&#123;	<span class="comment">//闹钟中断处理（启用时必须调高其优先级）</span></span><br><span class="line">	<span class="keyword">if</span>(RTC_GetITStatus(RTC_IT_ALR) != RESET)&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	RTC_ClearITPendingBit(RTC_IT_ALR);</span><br><span class="line">	RTC_WaitForLastTask();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否是闰年函数</span></span><br><span class="line"><span class="comment">//月份   1  2  3  4  5  6  7  8  9  10 11 12</span></span><br><span class="line"><span class="comment">//闰年   31 29 31 30 31 30 31 31 30 31 30 31</span></span><br><span class="line"><span class="comment">//非闰年 31 28 31 30 31 30 31 31 30 31 30 31</span></span><br><span class="line"><span class="comment">//输入:年份</span></span><br><span class="line"><span class="comment">//输出:该年份是不是闰年.1,是.0,不是</span></span><br><span class="line">u8 <span class="title function_">Is_Leap_Year</span><span class="params">(u16 year)</span>&#123;                    </span><br><span class="line">	<span class="keyword">if</span>(year%<span class="number">4</span>==<span class="number">0</span>)&#123; <span class="comment">//必须能被4整除</span></span><br><span class="line">		<span class="keyword">if</span>(year%<span class="number">100</span>==<span class="number">0</span>)&#123;		</span><br><span class="line">			<span class="keyword">if</span>(year%<span class="number">400</span>==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">1</span>;<span class="comment">//如果以00结尾,还要能被400整除          </span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;                           </span><br><span class="line"><span class="comment">//设置时钟</span></span><br><span class="line"><span class="comment">//把输入的时钟转换为秒钟</span></span><br><span class="line"><span class="comment">//以1970年1月1日为基准</span></span><br><span class="line"><span class="comment">//1970~2099年为合法年份</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//月份数据表                                                                       </span></span><br><span class="line">u8 <span class="type">const</span> table_week[<span class="number">12</span>]=&#123;<span class="number">0</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">5</span>&#125;; <span class="comment">//月修正数据表  </span></span><br><span class="line"><span class="type">const</span> u8 mon_table[<span class="number">12</span>]=&#123;<span class="number">31</span>,<span class="number">28</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">31</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">31</span>&#125;;<span class="comment">//平年的月份日期表</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//写入时间</span></span><br><span class="line">u8 <span class="title function_">RTC_Set</span><span class="params">(u16 syear,u8 smon,u8 sday,u8 hour,u8 min,u8 sec)</span>&#123; <span class="comment">//写入当前时间（1970~2099年有效），</span></span><br><span class="line">	u16 t;</span><br><span class="line">	u32 seccount=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(syear&lt;<span class="number">2000</span>||syear&gt;<span class="number">2099</span>)<span class="keyword">return</span> <span class="number">1</span>;<span class="comment">//syear范围1970-2099，此处设置范围为2000-2099       </span></span><br><span class="line">	<span class="keyword">for</span>(t=<span class="number">1970</span>;t&lt;syear;t++)&#123; <span class="comment">//把所有年份的秒钟相加</span></span><br><span class="line">		<span class="keyword">if</span>(Is_Leap_Year(t))seccount+=<span class="number">31622400</span>;<span class="comment">//闰年的秒钟数</span></span><br><span class="line">		<span class="keyword">else</span> seccount+=<span class="number">31536000</span>;                    <span class="comment">//平年的秒钟数</span></span><br><span class="line">	&#125;</span><br><span class="line">	smon-=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(t=<span class="number">0</span>;t&lt;smon;t++)&#123;         <span class="comment">//把前面月份的秒钟数相加</span></span><br><span class="line">		seccount+=(u32)mon_table[t]*<span class="number">86400</span>;<span class="comment">//月份秒钟数相加</span></span><br><span class="line">		<span class="keyword">if</span>(Is_Leap_Year(syear)&amp;&amp;t==<span class="number">1</span>)seccount+=<span class="number">86400</span>;<span class="comment">//闰年2月份增加一天的秒钟数        </span></span><br><span class="line">	&#125;</span><br><span class="line">	seccount+=(u32)(sday<span class="number">-1</span>)*<span class="number">86400</span>;<span class="comment">//把前面日期的秒钟数相加</span></span><br><span class="line">	seccount+=(u32)hour*<span class="number">3600</span>;<span class="comment">//小时秒钟数</span></span><br><span class="line">	seccount+=(u32)min*<span class="number">60</span>;      <span class="comment">//分钟秒钟数</span></span><br><span class="line">	seccount+=sec;<span class="comment">//最后的秒钟加上去</span></span><br><span class="line">	RTC_First_Config(); <span class="comment">//重新初始化时钟</span></span><br><span class="line">	BKP_WriteBackupRegister(BKP_DR1, <span class="number">0xA5A5</span>);<span class="comment">//配置完成后，向后备寄存器中写特殊字符0xA5A5</span></span><br><span class="line">	RTC_SetCounter(seccount);<span class="comment">//把换算好的计数器值写入</span></span><br><span class="line">	RTC_WaitForLastTask(); <span class="comment">//等待写入完成</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//返回值:0,成功;其他:错误代码.    </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读出时间</span></span><br><span class="line">u8 <span class="title function_">RTC_Get</span><span class="params">(<span class="type">void</span>)</span>&#123;<span class="comment">//读出当前时间值 //返回值:0,成功;其他:错误代码.</span></span><br><span class="line">	<span class="type">static</span> u16 daycnt=<span class="number">0</span>;</span><br><span class="line">	u32 timecount=<span class="number">0</span>;</span><br><span class="line">	u32 temp=<span class="number">0</span>;</span><br><span class="line">	u16 temp1=<span class="number">0</span>;</span><br><span class="line">	timecount=RTC_GetCounter();		</span><br><span class="line">	temp=timecount/<span class="number">86400</span>;   <span class="comment">//得到天数(秒钟数对应的)</span></span><br><span class="line">	<span class="keyword">if</span>(daycnt!=temp)&#123;<span class="comment">//超过一天了</span></span><br><span class="line">		daycnt=temp;</span><br><span class="line">		temp1=<span class="number">1970</span>;  <span class="comment">//从1970年开始</span></span><br><span class="line">		<span class="keyword">while</span>(temp&gt;=<span class="number">365</span>)&#123;</span><br><span class="line">		     <span class="keyword">if</span>(Is_Leap_Year(temp1))&#123;<span class="comment">//是闰年</span></span><br><span class="line">			     <span class="keyword">if</span>(temp&gt;=<span class="number">366</span>)temp-=<span class="number">366</span>;<span class="comment">//闰年的秒钟数</span></span><br><span class="line">			     <span class="keyword">else</span> &#123;temp1++;<span class="keyword">break</span>;&#125; </span><br><span class="line">		     &#125;</span><br><span class="line">		     <span class="keyword">else</span> temp-=<span class="number">365</span>;       <span class="comment">//平年</span></span><br><span class="line">		     temp1++; </span><br><span class="line">		&#125;  </span><br><span class="line">		ryear=temp1;<span class="comment">//得到年份</span></span><br><span class="line">		temp1=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>(temp&gt;=<span class="number">28</span>)&#123;<span class="comment">//超过了一个月</span></span><br><span class="line">			<span class="keyword">if</span>(Is_Leap_Year(ryear)&amp;&amp;temp1==<span class="number">1</span>)&#123;<span class="comment">//当年是不是闰年/2月份</span></span><br><span class="line">				<span class="keyword">if</span>(temp&gt;=<span class="number">29</span>)temp-=<span class="number">29</span>;<span class="comment">//闰年的秒钟数</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	            <span class="keyword">if</span>(temp&gt;=mon_table[temp1])temp-=mon_table[temp1];<span class="comment">//平年</span></span><br><span class="line">	            <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			temp1++; </span><br><span class="line">		&#125;</span><br><span class="line">		rmon=temp1+<span class="number">1</span>;<span class="comment">//得到月份</span></span><br><span class="line">		rday=temp+<span class="number">1</span>;  <span class="comment">//得到日期</span></span><br><span class="line">	&#125;</span><br><span class="line">	temp=timecount%<span class="number">86400</span>;     <span class="comment">//得到秒钟数      </span></span><br><span class="line">	rhour=temp/<span class="number">3600</span>;     <span class="comment">//小时</span></span><br><span class="line">	rmin=(temp%<span class="number">3600</span>)/<span class="number">60</span>; <span class="comment">//分钟     </span></span><br><span class="line">	rsec=(temp%<span class="number">3600</span>)%<span class="number">60</span>; <span class="comment">//秒钟</span></span><br><span class="line">	rweek=RTC_Get_Week(ryear,rmon,rday);<span class="comment">//获取星期  </span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">RTC_Get_Week</span><span class="params">(u16 year,u8 month,u8 day)</span>&#123; <span class="comment">//按年月日计算星期(只允许1901-2099年)//已由RTC_Get调用    </span></span><br><span class="line">	u16 temp2;</span><br><span class="line">	u8 yearH,yearL;</span><br><span class="line">	yearH=year/<span class="number">100</span>;     </span><br><span class="line">	yearL=year%<span class="number">100</span>;</span><br><span class="line">	<span class="comment">// 如果为21世纪,年份数加100 </span></span><br><span class="line">	<span class="keyword">if</span> (yearH&gt;<span class="number">19</span>)yearL+=<span class="number">100</span>;</span><br><span class="line">	<span class="comment">// 所过闰年数只算1900年之后的 </span></span><br><span class="line">	temp2=yearL+yearL/<span class="number">4</span>;</span><br><span class="line">	temp2=temp2%<span class="number">7</span>;</span><br><span class="line">	temp2=temp2+day+table_week[month<span class="number">-1</span>];</span><br><span class="line">	<span class="keyword">if</span> (yearL%<span class="number">4</span>==<span class="number">0</span>&amp;&amp;month&lt;<span class="number">3</span>)temp2--;</span><br><span class="line">	<span class="keyword">return</span>(temp2%<span class="number">7</span>); <span class="comment">//返回星期值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-i2c"><a href="#4-i2c" class="headerlink" title="4. i2c"></a>4. i2c</h2><h3 id="i2c-h"><a href="#i2c-h" class="headerlink" title="i2c.h"></a>i2c.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __I2C_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __I2C_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> I2CPORT		GPIOB	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> I2C_SCL		GPIO_Pin_6	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> I2C_SDA		GPIO_Pin_7	<span class="comment">//定义IO接口</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HostAddress	0xc0	<span class="comment">//总线主机的器件地址</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BusSpeed	200000	<span class="comment">//总线速度（不高于400000）</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Configuration</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SAND_BUFFER</span><span class="params">(u8 SlaveAddr, u8 WriteAddr, u8* pBuffer, u16 NumByteToWrite)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SAND_BYTE</span><span class="params">(u8 SlaveAddr,u8 writeAddr,u8 pBuffer)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_READ_BUFFER</span><span class="params">(u8 SlaveAddr,u8 readAddr,u8* pBuffer,u16 NumByteToRead)</span>;</span><br><span class="line">u8 <span class="title function_">I2C_READ_BYTE</span><span class="params">(u8 SlaveAddr,u8 readAddr)</span>;</span><br><span class="line">		 				    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="i2c-c"><a href="#i2c-c" class="headerlink" title="i2c.c"></a>i2c.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;i2c.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_GPIO_Init</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//I2C接口初始化</span></span><br><span class="line">	GPIO_InitTypeDef  GPIO_InitStructure; 	</span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA|RCC_APB2Periph_GPIOB|RCC_APB2Periph_GPIOC,ENABLE);       </span><br><span class="line">	RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C1, ENABLE); <span class="comment">//启动I2C功能 </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = I2C_SCL | I2C_SDA; <span class="comment">//选择端口号                      </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_OD; <span class="comment">//选择IO接口工作方式       </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; <span class="comment">//设置IO接口速度（2/10/50MHz）    </span></span><br><span class="line">	GPIO_Init(I2CPORT, &amp;GPIO_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_Configuration</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//I2C初始化</span></span><br><span class="line">	I2C_InitTypeDef  I2C_InitStructure;</span><br><span class="line">	I2C_GPIO_Init(); <span class="comment">//先设置GPIO接口的状态</span></span><br><span class="line">	I2C_InitStructure.I2C_Mode = I2C_Mode_I2C;<span class="comment">//设置为I2C模式</span></span><br><span class="line">	I2C_InitStructure.I2C_DutyCycle = I2C_DutyCycle_2;</span><br><span class="line">	I2C_InitStructure.I2C_OwnAddress1 = HostAddress; <span class="comment">//主机地址（从机不得用此地址）</span></span><br><span class="line">	I2C_InitStructure.I2C_Ack = I2C_Ack_Enable;<span class="comment">//允许应答</span></span><br><span class="line">	I2C_InitStructure.I2C_AcknowledgedAddress = I2C_AcknowledgedAddress_7bit; <span class="comment">//7位地址模式</span></span><br><span class="line">	I2C_InitStructure.I2C_ClockSpeed = BusSpeed; <span class="comment">//总线速度设置 	</span></span><br><span class="line">	I2C_Init(I2C1,&amp;I2C_InitStructure);</span><br><span class="line">	I2C_Cmd(I2C1,ENABLE);<span class="comment">//开启I2C					</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SAND_BUFFER</span><span class="params">(u8 SlaveAddr,u8 WriteAddr,u8* pBuffer,u16 NumByteToWrite)</span>&#123; <span class="comment">//I2C发送数据串（器件地址，寄存器，内部地址，数量）</span></span><br><span class="line">	I2C_GenerateSTART(I2C1,ENABLE);<span class="comment">//产生起始位</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_MODE_SELECT)); <span class="comment">//清除EV5</span></span><br><span class="line">	I2C_Send7bitAddress(I2C1,SlaveAddr,I2C_Direction_Transmitter);<span class="comment">//发送器件地址</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));<span class="comment">//清除EV6</span></span><br><span class="line">	I2C_SendData(I2C1,WriteAddr); <span class="comment">//内部功能地址</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_TRANSMITTED));<span class="comment">//移位寄存器非空，数据寄存器已空，产生EV8，发送数据到DR既清除该事件</span></span><br><span class="line">	<span class="keyword">while</span>(NumByteToWrite--)&#123; <span class="comment">//循环发送数据	</span></span><br><span class="line">		I2C_SendData(I2C1,*pBuffer); <span class="comment">//发送数据</span></span><br><span class="line">		pBuffer++; <span class="comment">//数据指针移位</span></span><br><span class="line">		<span class="keyword">while</span> (!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_TRANSMITTED));<span class="comment">//清除EV8</span></span><br><span class="line">	&#125;</span><br><span class="line">	I2C_GenerateSTOP(I2C1,ENABLE);<span class="comment">//产生停止信号</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_SAND_BYTE</span><span class="params">(u8 SlaveAddr,u8 writeAddr,u8 pBuffer)</span>&#123; <span class="comment">//I2C发送一个字节（从地址，内部地址，内容）</span></span><br><span class="line">	I2C_GenerateSTART(I2C1,ENABLE); <span class="comment">//发送开始信号</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_MODE_SELECT)); <span class="comment">//等待完成	</span></span><br><span class="line">	I2C_Send7bitAddress(I2C1,SlaveAddr, I2C_Direction_Transmitter); <span class="comment">//发送从器件地址及状态（写入）</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED)); <span class="comment">//等待完成	</span></span><br><span class="line">	I2C_SendData(I2C1,writeAddr); <span class="comment">//发送从器件内部寄存器地址</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_TRANSMITTED)); <span class="comment">//等待完成	</span></span><br><span class="line">	I2C_SendData(I2C1,pBuffer); <span class="comment">//发送要写入的内容</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_TRANSMITTED)); <span class="comment">//等待完成	</span></span><br><span class="line">	I2C_GenerateSTOP(I2C1,ENABLE); <span class="comment">//发送结束信号</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">I2C_READ_BUFFER</span><span class="params">(u8 SlaveAddr,u8 readAddr,u8* pBuffer,u16 NumByteToRead)</span>&#123; <span class="comment">//I2C读取数据串（器件地址，寄存器，内部地址，数量）</span></span><br><span class="line">	<span class="keyword">while</span>(I2C_GetFlagStatus(I2C1,I2C_FLAG_BUSY));</span><br><span class="line">	I2C_GenerateSTART(I2C1,ENABLE);<span class="comment">//开启信号</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_MODE_SELECT));	<span class="comment">//清除 EV5</span></span><br><span class="line">	I2C_Send7bitAddress(I2C1,SlaveAddr, I2C_Direction_Transmitter); <span class="comment">//写入器件地址</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));<span class="comment">//清除 EV6</span></span><br><span class="line">	I2C_Cmd(I2C1,ENABLE);</span><br><span class="line">	I2C_SendData(I2C1,readAddr); <span class="comment">//发送读的地址</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_TRANSMITTED)); <span class="comment">//清除 EV8</span></span><br><span class="line">	I2C_GenerateSTART(I2C1,ENABLE); <span class="comment">//开启信号</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_MODE_SELECT)); <span class="comment">//清除 EV5</span></span><br><span class="line">	I2C_Send7bitAddress(I2C1,SlaveAddr,I2C_Direction_Receiver); <span class="comment">//将器件地址传出，主机为读</span></span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_RECEIVER_MODE_SELECTED)); <span class="comment">//清除EV6</span></span><br><span class="line">	<span class="keyword">while</span>(NumByteToRead)&#123;</span><br><span class="line">		<span class="keyword">if</span>(NumByteToRead == <span class="number">1</span>)&#123; <span class="comment">//只剩下最后一个数据时进入 if 语句</span></span><br><span class="line">			I2C_AcknowledgeConfig(I2C1,DISABLE); <span class="comment">//最后有一个数据时关闭应答位</span></span><br><span class="line">			I2C_GenerateSTOP(I2C1,ENABLE);	<span class="comment">//最后一个数据时使能停止位</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_RECEIVED))&#123; <span class="comment">//读取数据</span></span><br><span class="line">			*pBuffer = I2C_ReceiveData(I2C1);<span class="comment">//调用库函数将数据取出到 pBuffer</span></span><br><span class="line">			pBuffer++; <span class="comment">//指针移位</span></span><br><span class="line">			NumByteToRead--; <span class="comment">//字节数减 1 </span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	I2C_AcknowledgeConfig(I2C1,ENABLE);</span><br><span class="line">&#125;</span><br><span class="line">u8 <span class="title function_">I2C_READ_BYTE</span><span class="params">(u8 SlaveAddr,u8 readAddr)</span>&#123; <span class="comment">//I2C读取一个字节</span></span><br><span class="line">	u8 a;</span><br><span class="line">	<span class="keyword">while</span>(I2C_GetFlagStatus(I2C1,I2C_FLAG_BUSY));</span><br><span class="line">	I2C_GenerateSTART(I2C1,ENABLE);</span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_MODE_SELECT));</span><br><span class="line">	I2C_Send7bitAddress(I2C1,SlaveAddr, I2C_Direction_Transmitter); </span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));</span><br><span class="line">	I2C_Cmd(I2C1,ENABLE);</span><br><span class="line">	I2C_SendData(I2C1,readAddr);</span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_TRANSMITTED));</span><br><span class="line">	I2C_GenerateSTART(I2C1,ENABLE);</span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_MODE_SELECT));</span><br><span class="line">	I2C_Send7bitAddress(I2C1,SlaveAddr, I2C_Direction_Receiver);</span><br><span class="line">	<span class="keyword">while</span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_RECEIVER_MODE_SELECTED));</span><br><span class="line">	I2C_AcknowledgeConfig(I2C1,DISABLE); <span class="comment">//最后有一个数据时关闭应答位</span></span><br><span class="line">	I2C_GenerateSTOP(I2C1,ENABLE);	<span class="comment">//最后一个数据时使能停止位</span></span><br><span class="line">	a = I2C_ReceiveData(I2C1);</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">选择IO接口工作方式：</span></span><br><span class="line"><span class="comment">GPIO_Mode_AIN 模拟输入</span></span><br><span class="line"><span class="comment">GPIO_Mode_IN_FLOATING 浮空输入</span></span><br><span class="line"><span class="comment">GPIO_Mode_IPD 下拉输入</span></span><br><span class="line"><span class="comment">GPIO_Mode_IPU 上拉输入</span></span><br><span class="line"><span class="comment">GPIO_Mode_Out_PP 推挽输出</span></span><br><span class="line"><span class="comment">GPIO_Mode_Out_OD 开漏输出</span></span><br><span class="line"><span class="comment">GPIO_Mode_AF_PP 复用推挽输出</span></span><br><span class="line"><span class="comment">GPIO_Mode_AF_OD 复用开漏输出</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-flash"><a href="#5-flash" class="headerlink" title="5. flash"></a>5. flash</h2><h3 id="flash-h"><a href="#flash-h" class="headerlink" title="flash.h"></a>flash.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __FLASH_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FLASH_H 			   </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">FLASH_W</span><span class="params">(u32 add,u16 dat)</span>;</span><br><span class="line">u16 <span class="title function_">FLASH_R</span><span class="params">(u32 add)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="flash-c"><a href="#flash-c" class="headerlink" title="flash.c"></a>flash.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;flash.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//FLASH写入数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FLASH_W</span><span class="params">(u32 add,u16 dat)</span>&#123; <span class="comment">//参数1：32位FLASH地址。参数2：16位数据</span></span><br><span class="line"><span class="comment">//	 RCC_HSICmd(ENABLE); //打开HSI时钟</span></span><br><span class="line">	 FLASH_Unlock();  <span class="comment">//解锁FLASH编程擦除控制器</span></span><br><span class="line">     FLASH_ClearFlag(FLASH_FLAG_BSY|FLASH_FLAG_EOP|FLASH_FLAG_PGERR|FLASH_FLAG_WRPRTERR);<span class="comment">//清除标志位</span></span><br><span class="line">     FLASH_ErasePage(add);     <span class="comment">//擦除指定地址页</span></span><br><span class="line">     FLASH_ProgramHalfWord(add,dat); <span class="comment">//从指定页的addr地址开始写</span></span><br><span class="line">     FLASH_ClearFlag(FLASH_FLAG_BSY|FLASH_FLAG_EOP|FLASH_FLAG_PGERR|FLASH_FLAG_WRPRTERR);<span class="comment">//清除标志位</span></span><br><span class="line">     FLASH_Lock();    <span class="comment">//锁定FLASH编程擦除控制器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//FLASH读出数据</span></span><br><span class="line">u16 <span class="title function_">FLASH_R</span><span class="params">(u32 add)</span>&#123; <span class="comment">//参数1：32位读出FLASH地址。返回值：16位数据</span></span><br><span class="line">	u16 a;</span><br><span class="line">    a = *(u16*)(add);<span class="comment">//从指定页的addr地址开始读</span></span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h1><h2 id="1-TM1640"><a href="#1-TM1640" class="headerlink" title="1. TM1640"></a>1. TM1640</h2><h3 id="TM1640-h"><a href="#TM1640-h" class="headerlink" title="TM1640.h"></a>TM1640.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __TM1640_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __TM1640_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TM1640_GPIOPORT	GPIOA	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TM1640_DIN	GPIO_Pin_12	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TM1640_SCLK	GPIO_Pin_11	<span class="comment">//定义IO接口</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TM1640_LEDPORT	0xC8	<span class="comment">//定义IO接口</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_Init</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//初始化</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_led</span><span class="params">(u8 date)</span>;<span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_display</span><span class="params">(u8 address,u8 date)</span>;<span class="comment">//</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_display_add</span><span class="params">(u8 address,u8 date)</span>;<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">		 				    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="TM1640-c"><a href="#TM1640-c" class="headerlink" title="TM1640.c"></a>TM1640.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TM1640.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL  1   <span class="comment">//宏定义 通信速率（默认为1，如不能通信可加大数值）</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//地址模式的设置</span></span><br><span class="line"><span class="comment">//#define TM1640MEDO_ADD  0x40   //宏定义	自动加一模式</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TM1640MEDO_ADD  0x44   <span class="comment">//宏定义 固定地址模式（推荐）</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//显示亮度的设置</span></span><br><span class="line"><span class="comment">//#define TM1640MEDO_DISPLAY  0x88   //宏定义 亮度  最小</span></span><br><span class="line"><span class="comment">//#define TM1640MEDO_DISPLAY  0x89   //宏定义 亮度</span></span><br><span class="line"><span class="comment">//#define TM1640MEDO_DISPLAY  0x8a   //宏定义 亮度</span></span><br><span class="line"><span class="comment">//#define TM1640MEDO_DISPLAY  0x8b   //宏定义 亮度</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TM1640MEDO_DISPLAY  0x8c   <span class="comment">//宏定义 亮度（推荐）</span></span></span><br><span class="line"><span class="comment">//#define TM1640MEDO_DISPLAY  0x8d   //宏定义 亮度</span></span><br><span class="line"><span class="comment">//#define TM1640MEDO_DISPLAY  0x8f   //宏定义 亮度 最大</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TM1640MEDO_DISPLAY_OFF  0x80   <span class="comment">//宏定义 亮度 关</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_start</span><span class="params">()</span>&#123; <span class="comment">//通信时序 启始（基础GPIO操作）（低层）</span></span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">1</span>)); <span class="comment">//接口输出高电平1	</span></span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_SCLK,(BitAction)(<span class="number">1</span>)); <span class="comment">//接口输出高电平1	</span></span><br><span class="line">	delay_us(DEL);</span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">	delay_us(DEL);</span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_SCLK,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">	delay_us(DEL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_stop</span><span class="params">()</span>&#123; <span class="comment">//通信时序 结束（基础GPIO操作）（低层）</span></span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_SCLK,(BitAction)(<span class="number">1</span>)); <span class="comment">//接口输出高电平1	</span></span><br><span class="line">	delay_us(DEL);</span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">1</span>)); <span class="comment">//接口输出高电平1	</span></span><br><span class="line">	delay_us(DEL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_write</span><span class="params">(u8 date)</span>&#123;	<span class="comment">//写数据（低层）</span></span><br><span class="line">	u8 i;</span><br><span class="line">	u8 aa;</span><br><span class="line">	aa=date;</span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_SCLK,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">		GPIO_WriteBit(TM1640_GPIOPORT,TM1640_SCLK,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">		delay_us(DEL);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(aa&amp;<span class="number">0x01</span>)&#123;</span><br><span class="line">			GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">1</span>)); <span class="comment">//接口输出高电平1	</span></span><br><span class="line">			delay_us(DEL);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">			delay_us(DEL);</span><br><span class="line">		&#125;</span><br><span class="line">		GPIO_WriteBit(TM1640_GPIOPORT,TM1640_SCLK,(BitAction)(<span class="number">1</span>)); <span class="comment">//接口输出高电平1	</span></span><br><span class="line">		delay_us(DEL);</span><br><span class="line">		aa=aa&gt;&gt;<span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_SCLK,(BitAction)(<span class="number">0</span>)); <span class="comment">//接口输出0	</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_Init</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//TM1640接口初始化</span></span><br><span class="line">	GPIO_InitTypeDef  GPIO_InitStructure; 	</span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA|RCC_APB2Periph_GPIOB|RCC_APB2Periph_GPIOC,ENABLE);       </span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = TM1640_DIN | TM1640_SCLK; <span class="comment">//选择端口号（0~15或all）                        </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; <span class="comment">//选择IO接口工作方式       </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; <span class="comment">//设置IO接口速度（2/10/50MHz）    </span></span><br><span class="line">	GPIO_Init(TM1640_GPIOPORT, &amp;GPIO_InitStructure);</span><br><span class="line"></span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_DIN,(BitAction)(<span class="number">1</span>)); <span class="comment">//接口输出高电平1	</span></span><br><span class="line">	GPIO_WriteBit(TM1640_GPIOPORT,TM1640_SCLK,(BitAction)(<span class="number">1</span>)); <span class="comment">//接口输出高电平1	</span></span><br><span class="line">	TM1640_start();</span><br><span class="line">	TM1640_write(TM1640MEDO_ADD); <span class="comment">//设置数据，0x40,0x44分别对应地址自动加一和固定地址模式</span></span><br><span class="line">	TM1640_stop();</span><br><span class="line">	TM1640_start();</span><br><span class="line">	TM1640_write(TM1640MEDO_DISPLAY); <span class="comment">//控制显示，开显示，0x88,  0x89,  0x8a,  0x8b,  0x8c,  0x8d,  0x8e,  0x8f分别对应脉冲宽度为:</span></span><br><span class="line">					 				  <span class="comment">//------------------1/16,  2/16,  4/16,  10/16, 11/16, 12/16, 13/16, 14/16	 //0x80关显示</span></span><br><span class="line">	TM1640_stop();	</span><br><span class="line">				</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_led</span><span class="params">(u8 date)</span>&#123; <span class="comment">//固定地址模式的显示输出8个LED控制</span></span><br><span class="line">   TM1640_start();</span><br><span class="line">   TM1640_write(TM1640_LEDPORT);	        <span class="comment">//传显示数据对应的地址</span></span><br><span class="line">   TM1640_write(date);	<span class="comment">//传1BYTE显示数据</span></span><br><span class="line">   TM1640_stop();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_display</span><span class="params">(u8 address,u8 date)</span>&#123; <span class="comment">//固定地址模式的显示输出</span></span><br><span class="line"> 	<span class="type">const</span> u8 buff[<span class="number">23</span>]=&#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,<span class="number">0x6f</span>,<span class="number">0xbf</span>,<span class="number">0x86</span>,<span class="number">0xdb</span>,<span class="number">0xcf</span>,<span class="number">0xe6</span>,<span class="number">0xed</span>,<span class="number">0xfd</span>,<span class="number">0x87</span>,<span class="number">0xff</span>,<span class="number">0xef</span>,<span class="number">0x00</span>,<span class="number">0x40</span>,<span class="number">0x58</span>&#125;;<span class="comment">//数字0~9及0~9加点显示段码表</span></span><br><span class="line">    <span class="comment">//---------------   0    1    2    3    4    5    6    7    8    9    0.   1.   2.   3.   4.   5.   6.   7.   8.   9.   无   -     c</span></span><br><span class="line">   TM1640_start();</span><br><span class="line">   TM1640_write(<span class="number">0xC0</span>+address);	         <span class="comment">//传显示数据对应的地址</span></span><br><span class="line">   TM1640_write(buff[date]);				 <span class="comment">//传1BYTE显示数据</span></span><br><span class="line">   TM1640_stop();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">TM1640_display_add</span><span class="params">(u8 address,u8 date)</span>&#123;	<span class="comment">//地址自动加一模式的显示输出 </span></span><br><span class="line">	u8 i;</span><br><span class="line"> 	<span class="type">const</span> u8 buff[<span class="number">23</span>]=&#123;<span class="number">0x3f</span>,<span class="number">0x06</span>,<span class="number">0x5b</span>,<span class="number">0x4f</span>,<span class="number">0x66</span>,<span class="number">0x6d</span>,<span class="number">0x7d</span>,<span class="number">0x07</span>,<span class="number">0x7f</span>,<span class="number">0x6f</span>,<span class="number">0xbf</span>,<span class="number">0x86</span>,<span class="number">0xdb</span>,<span class="number">0xcf</span>,<span class="number">0xe6</span>,<span class="number">0xed</span>,<span class="number">0xfd</span>,<span class="number">0x87</span>,<span class="number">0xff</span>,<span class="number">0xef</span>,<span class="number">0x00</span>,<span class="number">0x40</span>,<span class="number">0x58</span>&#125;;<span class="comment">//数字0~9及0~9加点显示段码表</span></span><br><span class="line">    <span class="comment">//---------------   0    1    2    3    4    5    6    7    8    9    0.   1.   2.   3.   4.   5.   6.   7.   8.   9.   无   -     c</span></span><br><span class="line">  TM1640_start();</span><br><span class="line">   TM1640_write(<span class="number">0xC0</span>+address);	         <span class="comment">//设置起始地址</span></span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">16</span>;i++)&#123;</span><br><span class="line">      TM1640_write(buff[date]); </span><br><span class="line">   &#125;</span><br><span class="line">   TM1640_stop(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-LM75A"><a href="#2-LM75A" class="headerlink" title="2. LM75A"></a>2. LM75A</h2><h3 id="lm75a-h"><a href="#lm75a-h" class="headerlink" title="lm75a.h"></a>lm75a.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __LM75A_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LM75A_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;i2c.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LM75A_ADD	0x9E	<span class="comment">//器件地址</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">LM75A_GetTemp</span><span class="params">(u8 *Tempbuffer)</span>;<span class="comment">//读温度</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LM75A_POWERDOWN</span><span class="params">(<span class="type">void</span>)</span>; <span class="comment">//掉电模式</span></span><br><span class="line">		 				    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="lm75a-c"><a href="#lm75a-c" class="headerlink" title="lm75a.c"></a>lm75a.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lm75a.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//读出LM75A的温度值（-55~125摄氏度）</span></span><br><span class="line"><span class="comment">//温度正负号（0正1负），温度整数，温度小数（点后2位）依次放入*Tempbuffer（十进制）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LM75A_GetTemp</span><span class="params">(u8 *Tempbuffer)</span>&#123;   </span><br><span class="line">    u8 buf[<span class="number">2</span>]; <span class="comment">//温度值储存   </span></span><br><span class="line">    u8 t=<span class="number">0</span>,a=<span class="number">0</span>;   </span><br><span class="line">    I2C_READ_BUFFER(LM75A_ADD,<span class="number">0x00</span>,buf,<span class="number">2</span>); <span class="comment">//读出温度值（器件地址，子地址，数据储存器，字节数）</span></span><br><span class="line">	t = buf[<span class="number">0</span>]; <span class="comment">//处理温度整数部分，0~125度</span></span><br><span class="line">	*Tempbuffer = <span class="number">0</span>; <span class="comment">//温度值为正值</span></span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x80</span>)&#123; <span class="comment">//判断温度是否是负（MSB表示温度符号）</span></span><br><span class="line">		*Tempbuffer = <span class="number">1</span>; <span class="comment">//温度值为负值</span></span><br><span class="line">		t = ~t; t++; <span class="comment">//计算补码（原码取反后加1）</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x01</span>)&#123; a=a+<span class="number">1</span>; &#125; <span class="comment">//从高到低按位加入温度积加值（0~125）</span></span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x02</span>)&#123; a=a+<span class="number">2</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x04</span>)&#123; a=a+<span class="number">4</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x08</span>)&#123; a=a+<span class="number">8</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x10</span>)&#123; a=a+<span class="number">16</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x20</span>)&#123; a=a+<span class="number">32</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x40</span>)&#123; a=a+<span class="number">64</span>; &#125;</span><br><span class="line">	Tempbuffer++;</span><br><span class="line">	*Tempbuffer = a;</span><br><span class="line">	a = <span class="number">0</span>;</span><br><span class="line">	t = buf[<span class="number">1</span>]; <span class="comment">//处理小数部分，取0.125精度的前2位（12、25、37、50、62、75、87）</span></span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x20</span>)&#123; a=a+<span class="number">12</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x40</span>)&#123; a=a+<span class="number">25</span>; &#125;</span><br><span class="line">	<span class="keyword">if</span>(t &amp; <span class="number">0x80</span>)&#123; a=a+<span class="number">50</span>; &#125;</span><br><span class="line">	Tempbuffer++;</span><br><span class="line">	*Tempbuffer = a;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//LM75进入掉电模式，再次调用LM75A_GetTemp();即可正常工作</span></span><br><span class="line"><span class="comment">//建议只在需要低功耗情况下使用</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LM75A_POWERDOWN</span><span class="params">(<span class="type">void</span>)</span>&#123;<span class="comment">// </span></span><br><span class="line">    I2C_SAND_BYTE(LM75A_ADD,<span class="number">0x01</span>,<span class="number">1</span>); <span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-触摸按键"><a href="#3-触摸按键" class="headerlink" title="3. 触摸按键"></a>3. 触摸按键</h2><h3 id="touch-key-h"><a href="#touch-key-h" class="headerlink" title="touch_key.h"></a>touch_key.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __TOUCH_KEY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __TOUCH_KEY_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_KEYPORT	GPIOA	<span class="comment">//定义IO接口组</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_KEY_A		GPIO_Pin_0	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_KEY_B		GPIO_Pin_1	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_KEY_C		GPIO_Pin_2	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_KEY_D		GPIO_Pin_3	<span class="comment">//定义IO接口</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">TOUCH_KEY_Init</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//初始化</span></span><br><span class="line"></span><br><span class="line">		 				    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="touch-key-c"><a href="#touch-key-c" class="headerlink" title="touch_key.c"></a>touch_key.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;touch_key.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">TOUCH_KEY_Init</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//微动开关的接口初始化</span></span><br><span class="line">	GPIO_InitTypeDef  GPIO_InitStructure; <span class="comment">//定义GPIO的初始化枚举结构	</span></span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = TOUCH_KEY_A | TOUCH_KEY_B | TOUCH_KEY_C | TOUCH_KEY_D; <span class="comment">//选择端口                       </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU; <span class="comment">//选择IO接口工作方式 //上拉电阻       </span></span><br><span class="line">	GPIO_Init(TOUCH_KEYPORT,&amp;GPIO_InitStructure);			</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-BUZZER"><a href="#4-BUZZER" class="headerlink" title="4. BUZZER"></a>4. BUZZER</h2><h3 id="buzzer-h"><a href="#buzzer-h" class="headerlink" title="buzzer.h"></a>buzzer.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __BUZZER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __BUZZER_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUZZERPORT	GPIOB	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUZZER	GPIO_Pin_5	<span class="comment">//定义IO接口</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">BUZZER_Init</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//初始化</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">BUZZER_BEEP1</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//响一声</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MIDI_PLAY</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">		 				    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="buzzer-c"><a href="#buzzer-c" class="headerlink" title="buzzer.c"></a>buzzer.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;buzzer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">BUZZER_Init</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//蜂鸣器的接口初始化</span></span><br><span class="line">	GPIO_InitTypeDef  GPIO_InitStructure; 	</span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = BUZZER; <span class="comment">//选择端口号                        </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; <span class="comment">//选择IO接口工作方式       </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; <span class="comment">//设置IO接口速度（2/10/50MHz）    </span></span><br><span class="line">	GPIO_Init(BUZZERPORT, &amp;GPIO_InitStructure);	</span><br><span class="line">	</span><br><span class="line">	GPIO_WriteBit(BUZZERPORT,BUZZER,(BitAction)(<span class="number">1</span>)); <span class="comment">//蜂鸣器接口输出高电平1		</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">BUZZER_BEEP1</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//蜂鸣器响一声</span></span><br><span class="line">	u16 i;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">200</span>;i++)&#123;</span><br><span class="line">		GPIO_WriteBit(BUZZERPORT,BUZZER,(BitAction)(<span class="number">0</span>)); <span class="comment">//蜂鸣器接口输出0</span></span><br><span class="line">		delay_us(<span class="number">500</span>); <span class="comment">//延时		</span></span><br><span class="line">		GPIO_WriteBit(BUZZERPORT,BUZZER,(BitAction)(<span class="number">1</span>)); <span class="comment">//蜂鸣器接口输出高电平1</span></span><br><span class="line">		delay_us(<span class="number">500</span>); <span class="comment">//延时		</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uc16 music1[<span class="number">78</span>]=&#123; <span class="comment">//音乐1的数据表（奇数是音调，偶数是长度）</span></span><br><span class="line"><span class="number">330</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">440</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">494</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">523</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">587</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">659</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">587</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">494</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">392</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">440</span>,<span class="number">1500</span>,</span><br><span class="line"><span class="number">330</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">440</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">494</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">523</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">587</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">659</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">587</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">494</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">392</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">784</span>,<span class="number">1500</span>,</span><br><span class="line"><span class="number">659</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">698</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">784</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">880</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">784</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">698</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">659</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">587</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">659</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">523</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">494</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">440</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">440</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">494</span>,<span class="number">375</span>,</span><br><span class="line"><span class="number">523</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">523</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">494</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">392</span>,<span class="number">750</span>,</span><br><span class="line"><span class="number">440</span>,<span class="number">3000</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">MIDI_PLAY</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//MIDI音乐</span></span><br><span class="line">	u16 i,e;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">39</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(e=<span class="number">0</span>;e&lt;music1[i*<span class="number">2</span>]*music1[i*<span class="number">2</span>+<span class="number">1</span>]/<span class="number">1000</span>;e++)&#123;</span><br><span class="line">			GPIO_WriteBit(BUZZERPORT,BUZZER,(BitAction)(<span class="number">0</span>)); <span class="comment">//蜂鸣器接口输出0</span></span><br><span class="line">			delay_us(<span class="number">500000</span>/music1[i*<span class="number">2</span>]); <span class="comment">//延时		</span></span><br><span class="line">			GPIO_WriteBit(BUZZERPORT,BUZZER,(BitAction)(<span class="number">1</span>)); <span class="comment">//蜂鸣器接口输出高电平1</span></span><br><span class="line">			delay_us(<span class="number">500000</span>/music1[i*<span class="number">2</span>]); <span class="comment">//延时	</span></span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">选择IO接口工作方式：</span></span><br><span class="line"><span class="comment">GPIO_Mode_AIN 模拟输入</span></span><br><span class="line"><span class="comment">GPIO_Mode_IN_FLOATING 浮空输入</span></span><br><span class="line"><span class="comment">GPIO_Mode_IPD 下拉输入</span></span><br><span class="line"><span class="comment">GPIO_Mode_IPU 上拉输入</span></span><br><span class="line"><span class="comment">GPIO_Mode_Out_PP 推挽输出</span></span><br><span class="line"><span class="comment">GPIO_Mode_Out_OD 开漏输出</span></span><br><span class="line"><span class="comment">GPIO_Mode_AF_PP 复用推挽输出</span></span><br><span class="line"><span class="comment">GPIO_Mode_AF_OD 复用开漏输出</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-RELAY"><a href="#5-RELAY" class="headerlink" title="5. RELAY"></a>5. RELAY</h2><h3 id="relay-h"><a href="#relay-h" class="headerlink" title="relay.h"></a>relay.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __RELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __RELAY_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RELAYPORT	GPIOA	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RELAY1	GPIO_Pin_14	<span class="comment">//定义IO接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RELAY2	GPIO_Pin_13	<span class="comment">//定义IO接口</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RELAY_Init</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//继电器初始化</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RELAY_1</span><span class="params">(u8 c)</span>;<span class="comment">//继电器控制1</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RELAY_2</span><span class="params">(u8 c)</span>;<span class="comment">//继电器控制2</span></span><br><span class="line">		 				    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="relay-c"><a href="#relay-c" class="headerlink" title="relay.c"></a>relay.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;relay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RELAY_Init</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//继电器的接口初始化</span></span><br><span class="line">	GPIO_InitTypeDef  GPIO_InitStructure; 	</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_GPIOB | RCC_APB2Periph_GPIOC | RCC_APB2Periph_GPIOD | RCC_APB2Periph_GPIOE, ENABLE); <span class="comment">//APB2外设时钟使能      </span></span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);<span class="comment">//启动AFIO重映射功能时钟    </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = RELAY1 | RELAY2; <span class="comment">//选择端口号（0~15或all）                        </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; <span class="comment">//选择IO接口工作方式       </span></span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; <span class="comment">//设置IO接口速度（2/10/50MHz）    </span></span><br><span class="line">	GPIO_Init(RELAYPORT, &amp;GPIO_InitStructure);</span><br><span class="line">	<span class="comment">//必须将禁用JTAG功能才能做GPIO使用</span></span><br><span class="line">	GPIO_PinRemapConfig(GPIO_Remap_SWJ_Disable, ENABLE);<span class="comment">// 改变指定管脚的映射,完全禁用JTAG+SW-DP</span></span><br><span class="line">	GPIO_ResetBits(RELAYPORT,RELAY1 | RELAY2); <span class="comment">//都为低电平（0） 初始为关继电器							</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RELAY_1</span><span class="params">(u8 c)</span>&#123; <span class="comment">//继电器的控制程序（c=0继电器放开，c=1继电器吸合）</span></span><br><span class="line">	GPIO_WriteBit(RELAYPORT,RELAY1,(BitAction)(c));<span class="comment">//通过参数值写入接口</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">RELAY_2</span><span class="params">(u8 c)</span>&#123; <span class="comment">//继电器的控制程序（c=0继电器放开，c=1继电器吸合）</span></span><br><span class="line">	GPIO_WriteBit(RELAYPORT,RELAY2,(BitAction)(c));<span class="comment">//通过参数值写入接口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/10/23/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%B4%8B%E6%A1%83/%E7%94%B5%E5%AD%90%E6%97%B6%E9%92%9F/" rel="prev" title="洋桃stm32-电子扩展时钟">
                  <i class="fa fa-chevron-left"></i> 洋桃stm32-电子扩展时钟
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/11/01/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E7%A1%AC%E4%BB%B6%E5%AE%B6%E5%9B%AD/freertos/" rel="next" title="硬件家园-freertos详细讲解">
                  硬件家园-freertos详细讲解 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  




  




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"http://example.com/2023/10/23/%E5%B5%8C%E5%85%A5%E5%BC%8F/stm32/%E6%B4%8B%E6%A1%83/%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E4%BB%A3%E7%A0%81/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
